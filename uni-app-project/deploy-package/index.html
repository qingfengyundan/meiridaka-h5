<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生自律培养神器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F7;
            min-height: 100vh;
            color: #1C1C1E;
        }
        
        .container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        .status-bar {
            height: 44px;
            background: #000;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .page {
            display: none;
            min-height: calc(100vh - 124px);
            padding-bottom: 80px;
        }
        
        .page.active {
            display: block;
        }
        
        .page-transition {
            transition: all 0.3s ease-in-out;
        }
        
        .header {
            background: white;
            color: #1C1C1E;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #E5E5EA;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .header .slogan {
            opacity: 0.8;
            font-size: 0.9em;
            color: #007AFF;
            margin-top: 5px;
        }
        
        .header .date {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #e5e7eb;
            margin: 20px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #007AFF;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
        
        .section {
            margin: 20px;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .task-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:hover {
            background: #f8f9fa;
        }
        
        .task-item.completed {
            opacity: 0.6;
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
        }
        
        .task-checkbox {
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .task-meta {
            font-size: 0.8em;
            color: #666;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .task-points {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .deadline {
            color: #10b981;
            font-size: 0.85em;
            padding: 2px 6px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            white-space: nowrap;
        }
        
        .deadline.overdue {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn-complete, .btn-edit, .btn-delete {
            background: none;
            border: none;
            font-size: 1.4em;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            position: relative;
            overflow: hidden;
        }
        
        /* 未完成任务的圆圈样式 */
        .btn-complete:not(:disabled) {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            border: 3px solid #fff;
        }
        
        .btn-complete:not(:disabled):hover {
            background: linear-gradient(135deg, #ff5252, #ff7979);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        /* 已完成任务的勾选样式 */
        .btn-complete:disabled {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            border: 3px solid #fff;
            animation: completePulse 2s ease-in-out;
        }
        
        .btn-complete:disabled:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }
        
        .btn-edit {
            color: #3b82f6;
        }
        
        .btn-edit:hover {
            background: #eff6ff;
            transform: scale(1.1);
        }
        
        .btn-delete {
            color: #ef4444;
        }
        
        .btn-delete:hover {
            background: #fef2f2;
            transform: scale(1.1);
        }
        
        .btn-complete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 增强的打卡按钮样式 */
        .check-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 60px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .check-btn:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .check-btn.checking-in {
            background: #FF9500;
            animation: pulse 1s infinite;
            cursor: not-allowed;
        }

        .check-btn.completed {
            background: #28a745;
            color: white;
        }

        .check-btn.completed:hover {
            background: #1e7e34;
            transform: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* 完成任务时的脉冲动画 */
        @keyframes completePulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 8px 25px rgba(78, 205, 196, 0.5);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            }
        }
        
        /* 点击时的波纹效果 */
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .btn-complete::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-complete:active::before {
            width: 300px;
            height: 300px;
            animation: ripple 0.6s ease-out;
        }
        
        /* 悬浮时的发光效果 */
        .btn-complete:not(:disabled):hover {
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3), 0 0 20px rgba(255, 107, 107, 0.2);
            }
            to {
                box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4), 0 0 30px rgba(255, 107, 107, 0.3);
            }
        }

        /* 任务项完成状态样式 */
        .task-item.completed {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .add-task {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .add-task:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        /* 任务页面头部样式 */
        .task-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px 15px 30px;
            background: white;
            color: #1C1C1E;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 20px 20px;
            border-bottom: 1px solid #E5E5EA;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .page-title {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .add-task-btn-new {
            background: #007AFF;
            border: 2px solid #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .add-task-btn-new:hover {
            background: #0056CC;
            border-color: #0056CC;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        
        .add-task-btn-new:active {
            transform: translateY(0);
        }
        
        .add-icon {
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1;
        }
        
        .add-text {
            font-size: 0.9em;
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .task-page-header {
                padding: 15px 25px 12px 25px;
            }
            
            .page-title {
                font-size: 1.3em;
            }
            
            .add-task-btn-new {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .add-text {
                display: none;
            }
            
            .add-icon {
                font-size: 1.4em;
            }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 414px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 16px 34px 16px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            padding: 6px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            font-size: 0.75em;
            color: #8E8E93;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            flex: 1;
            max-width: 80px;
        }
        
        .nav-item:hover {
            transform: scale(1.05);
        }
        
        .nav-item.active {
            color: #007AFF;
        }
        
        .nav-icon {
            font-size: 1.4em;
            margin-bottom: 2px;
            transition: all 0.2s ease;
        }
        
        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .form-input:disabled {
            background-color: #f9fafb;
            color: #6b7280;
            cursor: not-allowed;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1em;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .points-hint {
            margin-top: 6px;
            font-size: 0.85em;
            color: #6b7280;
            font-style: italic;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-secondary {
            background: #e5e7eb;
            color: #333;
        }
        

        
        /* 优先级按钮样式 */
        .priority-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        
        .priority-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .priority-btn:hover {
            border-color: #007AFF;
        }
        
        .priority-btn.active {
            border-color: #007AFF;
            background: #E3F2FD;
        }
        
        .priority-btn[data-priority="low"].active {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .priority-btn[data-priority="medium"].active {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .priority-btn[data-priority="high"].active {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .priority-icon {
            font-size: 1.2em;
        }
        
        /* 任务项优先级指示器 */
        .task-item {
            position: relative;
        }
        
        .task-item[data-priority="high"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ef4444;
            border-radius: 0 4px 4px 0;
        }
        
        .task-item[data-priority="medium"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #f59e0b;
            border-radius: 0 4px 4px 0;
        }
        
        .task-item[data-priority="low"]::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #10b981;
            border-radius: 0 4px 4px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        /* 首页样式 */
        .welcome-section {
            background: white;
            color: #1C1C1E;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid #E5E5EA;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .edit-profile-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin: 0 auto 15px;
        }
        
        .user-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-level {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .points-display {
            font-size: 1.1em;
            font-weight: 500;
        }
        
        /* 月度统计样式 */
        .monthly-stats {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .monthly-stats-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .monthly-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .monthly-stat-item {
            background: white;
            padding: 15px 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .monthly-stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }
        
        .monthly-stat-label {
            font-size: 0.8em;
            color: #666;
        }
        
        /* 首页任务区域样式 */
        .home-tasks-section {
            padding: 20px;
            background: white;
        }
        
        .home-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .home-tasks-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .progress-section {
            padding: 20px;
            background: white;
        }
        
        .progress-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .progress-bar-container {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: #007AFF;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        /* 快速统计样式 */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .quick-stat-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .quick-stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }
        
        .quick-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        /* 最新成就样式 */
        .recent-achievements {
            padding: 20px;
        }
        
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
        }
        
        .achievement-item.unlocked {
            border-left-color: #34c759;
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 15px;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .achievement-desc {
            font-size: 14px;
            color: #666;
        }
        
        /* 统计页面样式 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-card-value {
            font-size: 2em;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }
        
        .stat-card-desc {
            font-size: 0.8em;
            color: #999;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .chart {
            height: 200px;
            display: flex;
            align-items: end;
            justify-content: space-between;
            gap: 8px;
        }
        
        .chart-bar {
            background: #007AFF;
            border-radius: 4px 4px 0 0;
            min-height: 20px;
            flex: 1;
            position: relative;
        }
        
        .chart-day {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            color: #666;
        }
        
        .history-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-weight: 500;
        }
        
        .history-count {
            color: #007AFF;
            font-weight: bold;
        }
        
        /* 商城页面样式 */
        .points-balance {
            margin-bottom: 20px;
        }
        
        .balance-card {
            background: white;
            color: #1C1C1E;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .balance-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .balance-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .balance-desc {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 15px;
        }
        
        .history-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .shop-categories, .task-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            flex-wrap: nowrap;
        }
        
        .task-categories {
            justify-content: space-between;
            gap: 8px;
        }
        
        .task-categories .category-btn {
            flex: 1;
            text-align: center;
            min-width: 0;
        }
        
        .category-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            font-size: 0.9em;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .category-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .shop-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .shop-item:hover {
            transform: translateY(-2px);
        }
        
        .shop-item-image {
            height: 120px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
        }
        
        .shop-item-info {
            padding: 15px;
        }
        
        .shop-item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .shop-item-price {
            color: #f59e0b;
            font-weight: bold;
        }

        /* 商品卡片新结构样式 */
        .shop-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .shop-item.disabled {
            opacity: 0.7;
        }

        .shop-item-icon {
            height: 80px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            border-bottom: 1px solid #f0f0f0;
        }

        .shop-item-content {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .shop-item-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }

        .shop-item-desc {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
            flex: 1;
            line-height: 1.4;
        }

        .shop-item-price {
            color: #f59e0b;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        /* 兑换按钮样式 */
        .btn-buy {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        .btn-buy:hover:not(.disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }

        .btn-buy:active:not(.disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        .btn-buy.disabled {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            color: #fff;
            cursor: not-allowed;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
        }

        .btn-buy.disabled:hover {
            transform: none;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
        }
        
        /* 个人中心页面样式 */
        .profile-header {
            background: white;
            color: #1C1C1E;
            padding: 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            border: 1px solid #E5E5EA;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            background: #007AFF;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .username {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-level {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
        }
        
        .profile-stat {
            text-align: center;
        }
        
        .profile-stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .profile-stat-label {
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .profile-menu {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .menu-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
        }
        
        .menu-icon {
            font-size: 1.2em;
        }
        
        .menu-text {
            flex: 1;
            font-weight: 500;
        }
        
        .menu-arrow {
            color: #ccc;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #f8f9fa;
        }
        
        @media (max-width: 414px) {
            .app {
                margin: 0;
                box-shadow: none;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .shop-items {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-stats {
                justify-content: center;
            }
        }

        /* 家长管理页面样式 */
        .mode-switch {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .current-mode {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            color: #495057;
        }

        .switch-mode-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .switch-mode-btn:hover {
            background: #0056b3;
        }

        .parent-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .parent-section:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .parent-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #e3f2fd;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .parent-section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .task-points-list {
            margin-bottom: 15px;
        }

        .data-analysis {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            width: 100%;
            min-width: 0;
        }

        .analysis-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            min-width: 0;
            overflow: hidden;
        }

        .analysis-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .analysis-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .reward-management {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .reward-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .reward-btn:hover {
            background: #218838;
        }

        .parent-settings {
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item:hover {
            background: #e9ecef;
        }

        .setting-arrow {
            color: #6c757d;
            font-size: 18px;
        }

        /* 任务管理和商品管理样式 */
        .task-management-summary, .task-points-summary, .product-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .summary-stats-three {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            min-width: 0;
        }

        .summary-stats-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .summary-stats-row .summary-item {
            flex: 1;
            min-width: 120px;
        }

        .summary-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .summary-stats-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .summary-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .data-analysis {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .summary-stats-three {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .analysis-item {
                padding: 8px;
            }

            .analysis-label {
                font-size: 12px;
            }

            .analysis-value {
                font-size: 18px;
            }

            .summary-item {
                padding: 8px;
            }

            .summary-label {
                font-size: 10px;
            }

            .summary-value {
                font-size: 16px;
            }
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            min-width: 0;
            overflow: hidden;
        }

        .summary-label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .summary-value {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
        }

        .task-management-actions, .task-points-actions, .product-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .task-management-actions-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .task-management-actions .btn, .task-points-actions .btn, .product-actions .btn,
        .task-management-actions-row .btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .task-management-actions .btn:hover, .task-points-actions .btn:hover, .product-actions .btn:hover,
        .task-management-actions-row .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .task-management-actions .btn-primary, .task-points-actions .btn-primary, .product-actions .btn-primary,
        .task-management-actions-row .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .task-management-actions .btn-success, .task-points-actions .btn-success, .product-actions .btn-success,
        .task-management-actions-row .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .task-management-actions .btn-secondary, .task-points-actions .btn-secondary, .product-actions .btn-secondary,
        .task-management-actions-row .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .task-management-actions .btn-info, .task-points-actions .btn-info, .product-actions .btn-info,
        .task-management-actions-row .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        /* 家长管理中心响应式优化 */
        @media (max-width: 768px) {
            .parent-section {
                padding: 16px;
                margin-bottom: 16px;
                border-radius: 12px;
            }
            
            .parent-section-title {
                font-size: 18px;
                margin-bottom: 16px;
                padding-bottom: 10px;
            }
            
            .task-management-actions, .task-points-actions, .product-actions,
            .task-management-actions-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .task-management-actions .btn, .task-points-actions .btn, .product-actions .btn,
            .task-management-actions-row .btn {
                min-width: auto;
                width: 100%;
                padding: 14px 16px;
                font-size: 15px;
            }
            
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .summary-item {
                padding: 8px;
            }
            
            .summary-value {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .parent-section {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .parent-section-title {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .summary-stats-row {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .task-management-actions .btn, .task-points-actions .btn, .product-actions .btn,
            .task-management-actions-row .btn {
                padding: 12px 14px;
                font-size: 14px;
            }
        }



        .btn-small.btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-small.btn-edit:hover {
            background: #0056b3;
        }

        .btn-small.btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-small.btn-delete:hover {
            background: #c82333;
        }

        /* 大型模态框样式 */
        .large-modal {
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .task-points-filter, .product-filter, .exchange-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .task-points-filter select, .product-filter select, .exchange-filter select,
        .exchange-filter input {
            flex: 1;
            max-width: 200px;
        }

        /* 任务积分编辑列表样式 */
        .task-points-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .task-points-info {
            flex: 1;
        }

        .task-points-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-points-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .task-points-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .points-input {
            width: 80px;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* 商品管理列表样式 */
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .product-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            border: 2px solid #e9ecef;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .product-description {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .product-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .product-points {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-right: 15px;
        }

        /* 头像选择器样式 */
        .avatar-selector {
            margin-top: 10px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .avatar-option {
            width: 40px;
            height: 40px;
            border: 2px solid #E5E5EA;
            border-radius: 50%;
            background: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-option:hover {
            border-color: #007AFF;
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #007AFF;
            background: #F0F8FF;
            transform: scale(1.1);
        }

        .selected-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #F2F2F7;
            border-radius: 8px;
            font-size: 14px;
        }

        .selected-avatar span:last-child {
            font-size: 20px;
        }

        .product-controls {
            display: flex;
            gap: 5px;
        }

        .product-controls .btn {
            padding: 5px 10px;
            font-size: 12px;
        }

        .product-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }

        .product-status.enabled {
            background: #d4edda;
            color: #155724;
        }

        .product-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        /* 图标选择器样式 */
        .icon-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .icon-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        /* 兑换历史样式 */
        .exchange-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .exchange-info {
            flex: 1;
        }

        .exchange-product {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .exchange-date {
            font-size: 12px;
            color: #6c757d;
        }

        .exchange-points {
            font-size: 16px;
            font-weight: bold;
            color: #dc3545;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .task-points-actions, .product-actions {
                flex-direction: column;
            }
            
            .task-points-item, .product-item, .exchange-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .task-points-controls, .product-controls {
                width: 100%;
                justify-content: flex-end;
            }
            
            .icon-selector {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* 模式切换弹窗 */
        .mode-switch-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .mode-switch-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .mode-switch-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }

        .password-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .mode-switch-buttons {
            display: flex;
            gap: 10px;
        }

        .mode-switch-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .confirm-btn {
            background: #007bff;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        /* 任务管理模态框样式 */
        .task-management-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .task-management-filter .form-select {
            flex: 1;
            min-width: 120px;
        }

        .task-management-list {
            max-height: 450px;
            overflow-y: auto;
            border: none;
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
        }

        .task-management-item {
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-areas: "icon info";
            align-items: flex-start;
            gap: 16px;
            padding: 20px;
            border: 2px solid transparent;
            border-radius: 16px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .task-management-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-management-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,123,255,0.15);
            border-color: #007bff;
            background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
        }

        .task-management-item:hover::before {
            opacity: 1;
        }

        .task-management-item .task-icon {
            grid-area: icon;
            font-size: 28px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
            transition: all 0.3s ease;
        }

        .task-management-item:hover .task-icon {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            transform: scale(1.05);
        }

        .task-management-item .task-info {
            grid-area: info;
            min-width: 0;
            overflow: hidden;
        }

        .task-management-item .task-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 17px;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.02em;
        }

        .task-management-item .task-meta {
            font-size: 13px;
            color: #6c757d;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            line-height: 1.4;
        }

        .task-management-item .task-meta > span {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 6px;
            font-weight: 500;
        }

        .task-management-item .task-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            gap: 16px;
        }

        .task-management-item .task-creator-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            flex: 1;
        }

        .task-management-item .task-creator-info > span {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-management-item .task-points {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .task-management-item:hover .task-points {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .task-management-item .task-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .task-management-item .task-status.active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        .task-management-item .task-status.inactive {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-color: #dc3545;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
        }

        .task-management-item .task-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .task-management-item .task-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 10px;
            white-space: nowrap;
            min-width: 60px;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .task-management-item .task-actions .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .task-management-item .task-actions .btn:hover::before {
            left: 100%;
        }

        .task-management-item .task-actions .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .task-management-item .task-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
            border-color: #0056b3;
        }

        .task-management-item .task-actions .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .task-management-item .task-actions .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
            border-color: #545b62;
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            .task-management-list {
                padding: 16px;
                max-height: 400px;
            }
            
            .task-management-item {
                gap: 12px;
                padding: 16px;
                margin-bottom: 12px;
            }
            
            .task-management-item .task-icon {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
            
            .task-management-item .task-title {
                font-size: 16px;
                white-space: normal;
                margin-bottom: 6px;
            }
            
            .task-management-item .task-meta {
                gap: 12px;
                font-size: 12px;
            }
            
            .task-management-item .task-bottom-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .task-management-item .task-creator-info {
                justify-content: space-between;
                gap: 8px;
            }
            
            .task-management-item .task-actions {
                justify-content: center;
                gap: 8px;
            }
            
            .task-management-item .task-actions .btn {
                padding: 8px 14px;
                font-size: 12px;
                min-width: 65px;
            }
        }

        @media (max-width: 480px) {
            .task-management-list {
                padding: 12px;
            }
            
            .task-management-item {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "icon"
                    "info";
                text-align: center;
                padding: 14px;
            }
            
            .task-management-item .task-icon {
                justify-self: center;
                margin-bottom: 8px;
            }
            
            .task-management-item .task-info {
                text-align: left;
            }
            
            .task-management-item .task-meta {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .task-management-item .task-creator-info {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                text-align: center;
            }
            
            .task-management-item .task-actions {
                flex-direction: column;
                gap: 6px;
            }
            
            .task-management-item .task-actions .btn {
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
        }

        /* 删除确认模态框样式 */
        .delete-confirm-content {
            text-align: center;
            padding: 20px 0;
        }

        .delete-task-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .delete-task-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .delete-task-meta {
            font-size: 14px;
            color: #666;
        }

        /* 优先级按钮样式 */
        .priority-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .priority-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .priority-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .priority-btn.active {
            border-color: #007bff;
            background: #007bff;
            color: #fff;
        }

        .priority-btn .priority-icon {
            font-size: 12px;
        }

        /* 积分提示样式 */
        .points-hint {
            color: #666 !important;
            font-size: 12px !important;
            display: block !important;
            margin-top: 4px !important;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>学生自律培养神器</h1>
            <div class="slogan">优秀来自孩子自律习惯</div>
            <div class="date" id="currentDate"></div>
        </div>
        

        
        <!-- 首页 -->
        <div class="page active" id="homePage">
            <!-- 用户信息区域 -->
            <div class="welcome-section">
                <button class="edit-profile-btn" onclick="editProfile()">✏️</button>
                <div class="avatar" id="userAvatar">👤</div>
                <div class="user-name" id="userName">小明</div>
                <div class="user-level" id="userLevel">Lv.1 新手</div>
                <div class="points-display">累计总积分：<span id="homePoints">0</span></div>
            </div>
            
            <!-- 本月统计 -->
            <div class="monthly-stats">
                <h3 class="monthly-stats-title">📊 本月统计</h3>
                <div class="monthly-stats-grid">
                    <div class="monthly-stat-item">
                        <div class="monthly-stat-number" id="monthlyTotalTasks">0</div>
                        <div class="monthly-stat-label">总任务</div>
                    </div>
                    <div class="monthly-stat-item">
                        <div class="monthly-stat-number" id="monthlyCompletedTasks">0</div>
                        <div class="monthly-stat-label">已完成</div>
                    </div>
                    <div class="monthly-stat-item">
                        <div class="monthly-stat-number" id="monthlyPendingTasks">0</div>
                        <div class="monthly-stat-label">待完成</div>
                    </div>
                    <div class="monthly-stat-item">
                        <div class="monthly-stat-number" id="monthlyTotalPoints">0</div>
                        <div class="monthly-stat-label">总积分</div>
                    </div>
                </div>
            </div>

            <!-- 我的任务 -->
            <div class="home-tasks-section">
                <div class="home-tasks-header">
                    <h2 class="home-tasks-title">📝 我的任务</h2>
                    <button class="add-task-btn-new" onclick="showAddTaskModal()">
                        <span class="add-icon">+</span>
                        <span class="add-text">添加</span>
                    </button>
                </div>
                
                <div class="task-categories">
                    <button class="category-btn active" onclick="filterTasks('all')">全部</button>
                    <button class="category-btn" onclick="filterTasks('school')">学校</button>
                    <button class="category-btn" onclick="filterTasks('home')">家庭</button>
                    <button class="category-btn" onclick="filterTasks('temp')">临时</button>
                </div>
                
                <div class="task-list" id="homeTaskList">
                    <!-- 学校任务 -->
                    <div class="task-item" data-category="school">
                        <div class="task-icon school">📚</div>
                        <div class="task-content">
                            <div class="task-name">完成数学作业</div>
                            <div class="task-meta">
                                <span>每日任务</span>
                                <span class="task-points">+20积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <div class="task-item" data-category="school">
                        <div class="task-icon school">📝</div>
                        <div class="task-content">
                            <div class="task-name">背诵英语单词</div>
                            <div class="task-meta">
                                <span>每日任务</span>
                                <span class="task-points">+15积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <div class="task-item" data-category="school">
                        <div class="task-icon school">🔬</div>
                        <div class="task-content">
                            <div class="task-name">复习物理知识点</div>
                            <div class="task-meta">
                                <span>每周任务</span>
                                <span class="task-points">+25积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <!-- 家庭任务 -->
                    <div class="task-item" data-category="home">
                        <div class="task-icon home">🧹</div>
                        <div class="task-content">
                            <div class="task-name">整理房间</div>
                            <div class="task-meta">
                                <span>每日任务</span>
                                <span class="task-points">+10积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <div class="task-item" data-category="home">
                        <div class="task-icon home">🍽️</div>
                        <div class="task-content">
                            <div class="task-name">帮忙洗碗</div>
                            <div class="task-meta">
                                <span>每日任务</span>
                                <span class="task-points">+8积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <div class="task-item" data-category="home">
                        <div class="task-icon home">🛒</div>
                        <div class="task-content">
                            <div class="task-name">陪妈妈买菜</div>
                            <div class="task-meta">
                                <span>周末任务</span>
                                <span class="task-points">+15积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <!-- 临时任务 -->
                    <div class="task-item" data-category="temp">
                        <div class="task-icon temp">🏃</div>
                        <div class="task-content">
                            <div class="task-name">晨跑30分钟</div>
                            <div class="task-meta">
                                <span>本周任务</span>
                                <span class="task-points">+30积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                    
                    <div class="task-item" data-category="temp">
                        <div class="task-icon temp">📖</div>
                        <div class="task-content">
                            <div class="task-name">阅读课外书</div>
                            <div class="task-meta">
                                <span>本周任务</span>
                                <span class="task-points">+20积分</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="check-btn" onclick="toggleTask(this)">✓</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 任务页面 -->
        <div class="page" id="tasksPage">
            <!-- 任务页面头部 -->
            <div class="task-page-header">
                <h2 class="page-title">我的任务</h2>
                <button class="add-task-btn-new" onclick="showAddTaskModal()">
                    <span class="add-icon">+</span>
                    <span class="add-text">添加任务</span>
                </button>
            </div>
            
            <div class="task-categories">
                    <button class="category-btn active" onclick="filterTasks('all')">全部</button>
                    <button class="category-btn" onclick="filterTasks('school')">学校</button>
                    <button class="category-btn" onclick="filterTasks('home')">家庭</button>
                    <button class="category-btn" onclick="filterTasks('temp')">临时</button>
                </div>
            
            <div class="task-list" id="taskList">
                <!-- 学校任务 -->
                <div class="task-item" data-category="school">
                    <div class="task-icon school">📚</div>
                    <div class="task-content">
                        <div class="task-name">完成数学作业</div>
                        <div class="task-meta">
                            <span>每日任务</span>
                            <span class="task-points">+20积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <div class="task-item" data-category="school">
                    <div class="task-icon school">📝</div>
                    <div class="task-content">
                        <div class="task-name">背诵英语单词</div>
                        <div class="task-meta">
                            <span>每日任务</span>
                            <span class="task-points">+15积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <div class="task-item" data-category="school">
                    <div class="task-icon school">🔬</div>
                    <div class="task-content">
                        <div class="task-name">复习物理知识点</div>
                        <div class="task-meta">
                            <span>每周任务</span>
                            <span class="task-points">+25积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <!-- 家庭任务 -->
                <div class="task-item" data-category="home">
                    <div class="task-icon home">🧹</div>
                    <div class="task-content">
                        <div class="task-name">整理房间</div>
                        <div class="task-meta">
                            <span>每日任务</span>
                            <span class="task-points">+10积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <div class="task-item" data-category="home">
                    <div class="task-icon home">🍽️</div>
                    <div class="task-content">
                        <div class="task-name">帮忙洗碗</div>
                        <div class="task-meta">
                            <span>每日任务</span>
                            <span class="task-points">+8积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <div class="task-item" data-category="home">
                    <div class="task-icon home">🛒</div>
                    <div class="task-content">
                        <div class="task-name">陪妈妈买菜</div>
                        <div class="task-meta">
                            <span>周末任务</span>
                            <span class="task-points">+15积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <!-- 临时任务 -->
                <div class="task-item" data-category="temp">
                    <div class="task-icon temp">🏃</div>
                    <div class="task-content">
                        <div class="task-name">晨跑30分钟</div>
                        <div class="task-meta">
                            <span>本周任务</span>
                            <span class="task-points">+30积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
                
                <div class="task-item" data-category="temp">
                    <div class="task-icon temp">📖</div>
                    <div class="task-content">
                        <div class="task-name">阅读课外书</div>
                        <div class="task-meta">
                            <span>本周任务</span>
                            <span class="task-points">+20积分</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn" onclick="toggleTask(this)">✓</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计页面 -->
        <div class="page" id="statsPage" style="display: none;">
            <div class="section">
                <div class="section-title">
                    📊 数据统计
                </div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-card-title">本周完成率</div>
                        <div class="stat-card-value" id="weeklyRate">0%</div>
                        <div class="stat-card-desc">共完成 <span id="weeklyCompleted">0</span> 个任务</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">连续打卡</div>
                        <div class="stat-card-value" id="streakDays">0</div>
                        <div class="stat-card-desc">天</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">最近7天完成情况</div>
                    <div class="chart" id="weeklyChart"></div>
                </div>
                
                <div class="history-section">
                    <div class="section-title">📅 历史记录</div>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>
        </div>
        
        <!-- 商城页面 -->
        <div class="page" id="shopPage" style="display: none;">
            <div class="section">
                <div class="section-title">
                    🛒 积分商城
                </div>
                <div class="points-balance">
                    <div class="balance-card">
                        <div class="balance-title">我的积分</div>
                        <div class="balance-value" id="userBalance">0</div>
                        <div class="balance-desc">完成任务获得积分</div>
                        <button class="history-btn" onclick="viewExchangeHistory()">📋 兑换历史</button>
                    </div>
                </div>
                
                <div class="shop-categories">
                    <button class="category-btn active" onclick="filterShop('all')">全部</button>
                    <button class="category-btn" onclick="filterShop('digital')">娱乐类</button>
                <button class="category-btn" onclick="filterShop('physical')">实物类</button>
                    <button class="category-btn" onclick="filterShop('experience')">体验类</button>
                </div>
                
                <div class="shop-items" id="shopItems"></div>
            </div>
        </div>
        
        <!-- 个人中心页面 -->
        <div class="page" id="profilePage" style="display: none;">
            <div class="section">
                <div class="profile-header">
                    <div class="avatar">👤</div>
                    <div class="profile-info">
                        <div class="username" id="username">用户</div>
                        <div class="user-level">Lv.1 新手</div>
                    </div>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileTotalTasks">0</div>
                            <div class="profile-stat-label">总任务</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileTotalPoints">0</div>
                            <div class="profile-stat-label">总积分</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-menu">
                    <div class="menu-item" onclick="showModeSwitch()">
                        <div class="menu-icon">👨‍👩‍👧‍👦</div>
                        <div class="menu-text" id="parentModeMenuText">家长模式</div>
                        <div class="menu-arrow">></div>
                    </div>
                    <div class="menu-item" onclick="showSettings()">
                        <div class="menu-icon">⚙️</div>
                        <div class="menu-text">设置</div>
                        <div class="menu-arrow">></div>
                    </div>
                    <div class="menu-item" onclick="showAchievements()">
                        <div class="menu-icon">🏆</div>
                        <div class="menu-text">成就</div>
                        <div class="menu-arrow">></div>
                    </div>
                    <div class="menu-item" onclick="showHelp()">
                        <div class="menu-icon">❓</div>
                        <div class="menu-text">帮助</div>
                        <div class="menu-arrow">></div>
                    </div>
                    <div class="menu-item" onclick="showAbout()">
                        <div class="menu-icon">ℹ️</div>
                        <div class="menu-text">关于</div>
                        <div class="menu-arrow">></div>
                    </div>
                </div>
                
                <div class="profile-actions" id="parentOnlyActions" style="display: none;">
                    <button class="action-btn" onclick="exportData()">📤 导出数据</button>
                    <button class="action-btn" onclick="clearData()">🗑️ 清空数据</button>
                </div>
            </div>
        </div>
        
        <div style="height: 80px;"></div>
        
        <!-- 家长管理页面 -->
        <div class="page" id="parentPage">
            <div class="section">
                <div class="section-title">👨‍👩‍👧‍👦 家长管理中心</div>
                
                <!-- 用户模式切换 -->
                <div class="mode-switch">
                    <div class="current-mode">
                        当前模式：<span id="currentModeText">学生模式</span>
                        <button class="switch-mode-btn" onclick="switchToStudentMode()">切换到学生模式</button>
                    </div>
                </div>
                
                <!-- 任务管理 -->
                <div class="parent-section">
                    <div class="parent-section-title">📋 任务管理</div>
                    <div class="task-management-summary">
                        <div class="summary-stats-grid">
                            <div class="summary-item">
                                <span class="summary-label">总任务数</span>
                                <span class="summary-value" id="totalTasksCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">已完成</span>
                                <span class="summary-value" id="completedTasksCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">待完成</span>
                                <span class="summary-value" id="pendingTasksCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">总积分</span>
                                <span class="summary-value" id="totalPointsEarned">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="task-management-actions-row">
                        <button class="btn btn-primary" onclick="showTaskManagementModal()">📋 管理任务</button>
                        <button class="btn btn-success" onclick="showAddTaskFromParentModal()">➕ 添加任务</button>
                    </div>
                </div>
                
                <!-- 孩子数据分析 -->
                <div class="parent-section">
                    <div class="parent-section-title">📊 数据概览</div>
                    <div class="data-analysis">
                        <div class="analysis-item">
                            <div class="analysis-label">本周完成率</div>
                            <div class="analysis-value" id="weeklyCompletionRate">0%</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">平均每日积分</div>
                            <div class="analysis-value" id="avgDailyPoints">0</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">连续打卡天数</div>
                            <div class="analysis-value" id="streakDaysParent">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- 积分商品管理 -->
                <div class="parent-section">
                    <div class="parent-section-title">🎁 积分商品管理</div>
                    <div class="product-summary">
                        <div class="summary-stats-three">
                            <div class="summary-item">
                                <span class="summary-label">商品总数</span>
                                <span class="summary-value" id="totalProductsCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">已启用</span>
                                <span class="summary-value" id="activeProductsCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">兑换次数</span>
                                <span class="summary-value" id="totalExchangesCount">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="showProductsModal()">🛍️ 管理商品</button>
                        <button class="btn btn-secondary" onclick="showAddProductModal()">➕ 添加商品</button>
                        <button class="btn btn-info" onclick="showExchangeHistoryModal()">📋 兑换历史</button>
                    </div>
                </div>
                
                <!-- 设置选项 -->
                <div class="parent-section">
                    <div class="parent-section-title">⚙️ 设置</div>
                    <div class="parent-settings">
                        <div class="setting-item" onclick="changeParentPassword()">
                            <span>修改家长密码</span>
                            <span class="setting-arrow">></span>
                        </div>
                        <div class="setting-item" onclick="setReminders()">
                            <span>提醒设置</span>
                            <span class="setting-arrow">></span>
                        </div>
                        <div class="setting-item" onclick="exportDetailedData()">
                            <span>导出详细数据</span>
                            <span class="setting-arrow">></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模式切换弹窗 -->
        <div class="mode-switch-modal" id="modeSwitchModal">
            <div class="mode-switch-content">
                <div class="mode-switch-title">切换到家长模式</div>
                <input type="password" class="password-input" id="parentPassword" placeholder="请输入家长密码">
                <div class="mode-switch-buttons">
                    <button class="cancel-btn" onclick="hideModeSwitch()">取消</button>
                    <button class="confirm-btn" onclick="confirmModeSwitch()">确认</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">🏠</div>
                <div>首页</div>
            </button>
            <button class="nav-item" onclick="switchTab('stats')">
                <div class="nav-icon">📊</div>
                <div>统计</div>
            </button>
            <button class="nav-item" onclick="switchTab('profile')">
                <div class="nav-icon">👤</div>
                <div>我的</div>
            </button>
            <button class="nav-item" onclick="switchTab('shop')">
                <div class="nav-icon">🛒</div>
                <div>兑换</div>
            </button>
        </div>
    </div>
    
    <!-- 添加任务模态框 -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-title">添加新任务</div>
            
            <div class="form-group">
                <label class="form-label">任务名称</label>
                <input type="text" class="form-input" id="taskTitle" placeholder="请输入任务名称">
            </div>
            
            <div class="form-group">
                <label class="form-label">任务分类</label>
                <select class="form-select" id="taskCategory">
                    <option value="school">📚 学习任务</option>
                    <option value="home">🏠 家庭任务</option>
                    <option value="temp">⚡ 临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务频率</label>
                <select class="form-select" id="taskFrequency">
                    <option value="daily">每日任务</option>
                    <option value="weekly">每周任务</option>
                    <option value="weekend">周末任务</option>
                    <option value="current_week">本周任务</option>
                    <option value="temporary">临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">优先级</label>
                <div class="priority-buttons">
                    <button class="priority-btn" data-priority="low" onclick="selectPriority('low')">
                        <span class="priority-icon">🟢</span>
                        <span>低</span>
                    </button>
                    <button class="priority-btn active" data-priority="medium" onclick="selectPriority('medium')">
                        <span class="priority-icon">🟡</span>
                        <span>中</span>
                    </button>
                    <button class="priority-btn" data-priority="high" onclick="selectPriority('high')">
                        <span class="priority-icon">🔴</span>
                        <span>高</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group" id="pointsGroup">
                <label class="form-label">积分奖励</label>
                <input type="number" class="form-input" id="taskPoints" value="1" min="1" max="10">
                <small class="points-hint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">默认1分</small>
            </div>
            
            <div class="form-group" id="temporaryTaskGroup" style="display: none;">
                <label class="form-label">截止时间</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" class="form-input" id="taskDeadlineDate" style="flex: 1;">
                    <input type="time" class="form-input" id="taskDeadlineTime" style="flex: 1;" value="23:59">
                </div>
                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">请选择任务的截止日期和时间</small>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideAddTaskModal()">取消</button>
                <button class="btn btn-primary" onclick="addTask()">添加</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑任务模态框 -->
    <div class="modal" id="editTaskModal">
        <div class="modal-content">
            <div class="modal-title">编辑任务</div>
            
            <div class="form-group">
                <label class="form-label">任务名称</label>
                <input type="text" class="form-input" id="editTaskTitle" placeholder="请输入任务名称">
            </div>
            
            <div class="form-group">
                <label class="form-label">任务分类</label>
                <select class="form-select" id="editTaskCategory">
                    <option value="school">📚 学习任务</option>
                    <option value="home">🏠 家庭任务</option>
                    <option value="temp">⚡ 临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务频率</label>
                <select class="form-select" id="editTaskFrequency">
                    <option value="daily">每日任务</option>
                    <option value="weekly">每周任务</option>
                    <option value="weekend">周末任务</option>
                    <option value="current_week">本周任务</option>
                    <option value="temporary">临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">优先级</label>
                <div class="priority-buttons">
                    <button class="priority-btn" data-priority="low" onclick="selectEditPriority('low')">
                        <span class="priority-icon">🟢</span>
                        <span>低</span>
                    </button>
                    <button class="priority-btn" data-priority="medium" onclick="selectEditPriority('medium')">
                        <span class="priority-icon">🟡</span>
                        <span>中</span>
                    </button>
                    <button class="priority-btn" data-priority="high" onclick="selectEditPriority('high')">
                        <span class="priority-icon">🔴</span>
                        <span>高</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">积分奖励</label>
                <input type="number" class="form-input" id="editTaskPoints" value="1" min="1" max="10">
                <small class="edit-points-hint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">家长模式下可设置1-10分</small>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideEditTaskModal()">取消</button>
                <button class="btn btn-primary" onclick="saveEditTask()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑用户资料模态框 -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-title">✏️ 编辑资料</div>
            
            <div class="form-group">
                <label class="form-label">用户名</label>
                <input type="text" class="form-input" id="editUserName" placeholder="请输入用户名" maxlength="20">
            </div>
            
            <div class="form-group">
                <label class="form-label">选择头像</label>
                <div class="avatar-selector">
                    <div class="avatar-grid">
                        <button type="button" class="avatar-option" onclick="selectAvatar('👦')">👦</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('👧')">👧</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🧒')">🧒</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('👶')">👶</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐱')">🐱</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐶')">🐶</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐰')">🐰</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐻')">🐻</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🦊')">🦊</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐼')">🐼</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐸')">🐸</button>
                        <button type="button" class="avatar-option" onclick="selectAvatar('🐯')">🐯</button>
                    </div>
                    <input type="hidden" id="editUserAvatar" value="">
                    <div class="selected-avatar">
                        <span>当前选择：</span>
                        <span id="selectedAvatarDisplay">👤</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideEditProfileModal()">取消</button>
                <button class="btn btn-primary" onclick="saveUserProfile()">保存</button>
            </div>
        </div>
    </div>

    <!-- 任务管理模态框 -->
    <div class="modal" id="taskManagementModal">
        <div class="modal-content large-modal">
            <div class="modal-title">📋 任务管理</div>
            
            <div class="task-management-filter">
                <select class="form-select" id="taskManagementFilter" onchange="filterTaskManagement()">
                    <option value="all">全部任务</option>
                    <option value="school">学习任务</option>
                    <option value="home">家庭任务</option>
                    <option value="temp">临时任务</option>
                </select>
                <button class="btn btn-success" onclick="showAddTaskFromParentModal()">➕ 添加任务</button>
                <button class="btn btn-secondary" onclick="refreshTaskManagement()">🔄 刷新</button>
            </div>
            
            <div class="task-management-list" id="taskManagementList">
                <!-- 动态加载任务列表 -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideTaskManagementModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 家长添加任务模态框 -->
    <div class="modal" id="addTaskFromParentModal">
        <div class="modal-content">
            <div class="modal-title">➕ 添加新任务</div>
            
            <div class="form-group">
                <label class="form-label">任务名称</label>
                <input type="text" class="form-input" id="parentTaskTitle" placeholder="请输入任务名称">
            </div>
            
            <div class="form-group">
                <label class="form-label">任务分类</label>
                <select class="form-select" id="parentTaskCategory">
                    <option value="school">📚 学习任务</option>
                    <option value="home">🏠 家庭任务</option>
                    <option value="temp">⚡ 临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务频率</label>
                <select class="form-select" id="parentTaskFrequency">
                    <option value="daily">每日任务</option>
                    <option value="weekly">每周任务</option>
                    <option value="weekend">周末任务</option>
                    <option value="current_week">本周任务</option>
                    <option value="temporary">临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">优先级</label>
                <div class="priority-buttons">
                    <button class="priority-btn" data-priority="low" onclick="selectParentPriority('low')">
                        <span class="priority-icon">🟢</span>
                        <span>低</span>
                    </button>
                    <button class="priority-btn active" data-priority="medium" onclick="selectParentPriority('medium')">
                        <span class="priority-icon">🟡</span>
                        <span>中</span>
                    </button>
                    <button class="priority-btn" data-priority="high" onclick="selectParentPriority('high')">
                        <span class="priority-icon">🔴</span>
                        <span>高</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">积分奖励</label>
                <input type="number" class="form-input" id="parentTaskPoints" value="5" min="1" max="50">
                <small class="points-hint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">家长模式可设置1-50分</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务描述（可选）</label>
                <textarea class="form-input" id="parentTaskDescription" placeholder="请输入任务描述" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideAddTaskFromParentModal()">取消</button>
                <button class="btn btn-primary" onclick="addTaskFromParent()">添加</button>
            </div>
        </div>
    </div>

    <!-- 编辑任务模态框（家长版） -->
    <div class="modal" id="editTaskFromParentModal">
        <div class="modal-content">
            <div class="modal-title">✏️ 编辑任务</div>
            
            <div class="form-group">
                <label class="form-label">任务名称</label>
                <input type="text" class="form-input" id="editParentTaskTitle" placeholder="请输入任务名称">
            </div>
            
            <div class="form-group">
                <label class="form-label">任务分类</label>
                <select class="form-select" id="editParentTaskCategory">
                    <option value="school">📚 学习任务</option>
                    <option value="home">🏠 家庭任务</option>
                    <option value="temp">⚡ 临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务频率</label>
                <select class="form-select" id="editParentTaskFrequency">
                    <option value="daily">每日任务</option>
                    <option value="weekly">每周任务</option>
                    <option value="weekend">周末任务</option>
                    <option value="current_week">本周任务</option>
                    <option value="temporary">临时任务</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">优先级</label>
                <div class="priority-buttons">
                    <button class="priority-btn" data-priority="low" onclick="selectEditParentPriority('low')">
                        <span class="priority-icon">🟢</span>
                        <span>低</span>
                    </button>
                    <button class="priority-btn" data-priority="medium" onclick="selectEditParentPriority('medium')">
                        <span class="priority-icon">🟡</span>
                        <span>中</span>
                    </button>
                    <button class="priority-btn" data-priority="high" onclick="selectEditParentPriority('high')">
                        <span class="priority-icon">🔴</span>
                        <span>高</span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">积分奖励</label>
                <input type="number" class="form-input" id="editParentTaskPoints" value="5" min="1" max="50">
                <small class="points-hint" style="color: #666; font-size: 12px; display: block; margin-top: 4px;">家长模式可设置1-50分</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">任务描述（可选）</label>
                <textarea class="form-input" id="editParentTaskDescription" placeholder="请输入任务描述" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideEditTaskFromParentModal()">取消</button>
                <button class="btn btn-danger" onclick="deleteTaskFromParent()" style="margin-right: auto;">🗑️ 删除任务</button>
                <button class="btn btn-primary" onclick="saveEditTaskFromParent()">保存</button>
            </div>
        </div>
    </div>

    <!-- 删除任务确认模态框 -->
    <div class="modal" id="deleteTaskConfirmModal">
        <div class="modal-content">
            <div class="modal-title">🗑️ 确认删除</div>
            
            <div class="delete-confirm-content">
                <p>确定要删除以下任务吗？</p>
                <div class="delete-task-info">
                    <div class="delete-task-name" id="deleteTaskName"></div>
                    <div class="delete-task-meta" id="deleteTaskMeta"></div>
                </div>
                <p style="color: #dc3545; font-size: 14px; margin-top: 15px;">
                    ⚠️ 此操作不可撤销，任务相关的完成记录也将被删除。
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideDeleteTaskConfirmModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDeleteTask()">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 任务积分管理模态框 -->
    <div class="modal" id="taskPointsModal">
        <div class="modal-content large-modal">
            <div class="modal-title">📊 任务积分管理</div>
            
            <div class="task-points-filter">
                <select class="form-select" id="taskPointsFilter" onchange="filterTaskPoints()">
                    <option value="all">全部任务</option>
                    <option value="school">学习任务</option>
                    <option value="home">家庭任务</option>
                    <option value="temp">临时任务</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshTaskPoints()">🔄 刷新</button>
            </div>
            
            <div class="task-points-list" id="taskPointsEditList">
                <!-- 动态加载任务列表 -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideTaskPointsModal()">关闭</button>
                <button class="btn btn-primary" onclick="saveAllTaskPoints()">💾 保存所有更改</button>
            </div>
        </div>
    </div>
    
    <!-- 积分商品管理模态框 -->
    <div class="modal" id="productManagementModal">
        <div class="modal-content large-modal">
            <div class="modal-title">🛍️ 积分商品管理</div>
            
            <div class="product-filter">
                <select class="form-select" id="productCategoryFilter" onchange="filterProducts()">
                    <option value="all">全部分类</option>
                    <option value="entertainment">娱乐类</option>
                    <option value="physical">实物类</option>
                    <option value="experience">体验类</option>
                </select>
                <button class="btn btn-primary" onclick="showAddProductModal()">➕ 添加商品</button>
            </div>
            
            <div class="products-list" id="productsEditList">
                <!-- 动态加载商品列表 -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideProductsModal()">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑商品模态框 -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <div class="modal-title" id="editProductTitle">➕ 添加商品</div>
            
            <form id="productForm">
            <div class="form-group">
                <label class="form-label">商品名称</label>
                <input type="text" class="form-input" id="productName" placeholder="请输入商品名称">
            </div>
            
            <div class="form-group">
                <label class="form-label">商品描述</label>
                <textarea class="form-input" id="productDescription" placeholder="请输入商品描述" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">所需积分</label>
                <input type="number" class="form-input" id="productPoints" placeholder="请输入所需积分" min="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">商品分类</label>
                <select class="form-select" id="productCategory">
                    <option value="entertainment">🎮 娱乐类</option>
                    <option value="physical">🎁 实物类</option>
                    <option value="experience">🌟 体验类</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">商品图标</label>
                <div class="icon-selector">
                    <button class="icon-btn" data-icon="📚" onclick="selectIcon('📚')">📚</button>
                    <button class="icon-btn" data-icon="🎮" onclick="selectIcon('🎮')">🎮</button>
                    <button class="icon-btn" data-icon="🍎" onclick="selectIcon('🍎')">🍎</button>
                    <button class="icon-btn" data-icon="🎁" onclick="selectIcon('🎁')">🎁</button>
                    <button class="icon-btn" data-icon="⭐" onclick="selectIcon('⭐')">⭐</button>
                    <button class="icon-btn" data-icon="🏆" onclick="selectIcon('🏆')">🏆</button>
                    <button class="icon-btn" data-icon="🎯" onclick="selectIcon('🎯')">🎯</button>
                    <button class="icon-btn" data-icon="💎" onclick="selectIcon('💎')">💎</button>
                </div>
                <input type="hidden" id="productIcon" value="🎁">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="productEnabled" checked> 启用商品
                </label>
            </div>
            </form>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideEditProductModal()">取消</button>
                <button class="btn btn-primary" onclick="saveProduct()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 兑换历史模态框 -->
    <div class="modal" id="exchangeHistoryModal">
        <div class="modal-content large-modal">
            <div class="modal-title">📋 兑换历史</div>
            
            <div class="exchange-filter">
                <input type="date" class="form-input" id="exchangeDateFilter" onchange="filterExchangeHistory()">
                <select class="form-select" id="exchangeCategoryFilter" onchange="filterExchangeHistory()">
                    <option value="all">全部分类</option>
                    <option value="study">学习用品</option>
                    <option value="entertainment">娱乐时间</option>
                    <option value="special">特殊奖励</option>
                    <option value="physical">实物奖励</option>
                </select>
            </div>
            
            <div class="exchange-history-list" id="exchangeHistoryList">
                <!-- 动态加载兑换历史 -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideExchangeHistoryModal()">关闭</button>
                <button class="btn btn-info" onclick="exportExchangeHistory()">📤 导出历史</button>
            </div>
        </div>
    </div>
    
    <script>
        // 应用状态
        let totalPoints = parseInt(localStorage.getItem('totalPoints')) || 0;
        let completedTasks = JSON.parse(localStorage.getItem('completedTasks')) || [];
        let userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
            name: '小明',
            level: 1,
            avatar: '👤',
            streakDays: 0,
            totalTasks: 0,
            joinDate: new Date().toISOString()
        };
        
        // 任务数据
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        
        // 当前模式
        let currentMode = localStorage.getItem('currentMode') || 'student';
        let parentPassword = localStorage.getItem('parentPassword') || '123456';
        
        // 积分商品数据
        let products = JSON.parse(localStorage.getItem('products')) || [];
        
        // 兑换历史数据
        let exchangeHistory = JSON.parse(localStorage.getItem('exchangeHistory')) || [];
        
        // 成就系统数据
        const achievements = [
            {
                id: 'first_task',
                name: '初来乍到',
                description: '完成第一个任务',
                icon: '🎯',
                condition: (stats) => stats.completedTasks >= 1,
                points: 10
            },
            {
                id: 'streak_3',
                name: '坚持不懈',
                description: '连续打卡3天',
                icon: '🔥',
                condition: (stats) => stats.streakDays >= 3,
                points: 20
            },
            {
                id: 'streak_7',
                name: '一周达人',
                description: '连续打卡7天',
                icon: '⭐',
                condition: (stats) => stats.streakDays >= 7,
                points: 50
            },
            {
                id: 'points_100',
                name: '积分新手',
                description: '累计获得100积分',
                icon: '💎',
                condition: (stats) => stats.totalPoints >= 100,
                points: 30
            },
            {
                id: 'points_500',
                name: '积分达人',
                description: '累计获得500积分',
                icon: '👑',
                condition: (stats) => stats.totalPoints >= 500,
                points: 100
            },
            {
                id: 'tasks_50',
                name: '任务专家',
                description: '完成50个任务',
                icon: '🏆',
                condition: (stats) => stats.completedTasks >= 50,
                points: 80
            },
            {
                id: 'perfect_week',
                name: '完美一周',
                description: '一周内完成所有任务',
                icon: '🌟',
                condition: (stats) => stats.weeklyCompletionRate >= 100,
                points: 150
            }
        ];
        
        // 获取已解锁的成就
        function getUnlockedAchievements() {
            return JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
        }
        
        // 保存已解锁的成就
        function saveUnlockedAchievements(unlockedList) {
            localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedList));
        }
        
        // 检查并解锁新成就
        function checkAchievements() {
            const unlockedAchievements = getUnlockedAchievements();
            const stats = {
                completedTasks: completedTasks.length,
                totalPoints: totalPoints,
                streakDays: userProfile.streakDays,
                weeklyCompletionRate: calculateWeeklyCompletionRate()
            };
            
            const newlyUnlocked = [];
            
            achievements.forEach(achievement => {
                // 如果成就未解锁且满足条件
                if (!unlockedAchievements.includes(achievement.id) && achievement.condition(stats)) {
                    unlockedAchievements.push(achievement.id);
                    newlyUnlocked.push(achievement);
                }
            });
            
            if (newlyUnlocked.length > 0) {
                saveUnlockedAchievements(unlockedAchievements);
                
                // 显示成就解锁动画
                newlyUnlocked.forEach(achievement => {
                    showAchievementUnlock(achievement);
                    // 奖励积分
                    totalPoints += achievement.points;
                });
                
                // 保存更新后的积分
                localStorage.setItem('totalPoints', totalPoints.toString());
            }
        }
        
        // 计算本周完成率
        function calculateWeeklyCompletionRate() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const weekTasks = getAllTasks().filter(task => {
                const taskDate = new Date(task.createdAt);
                return taskDate >= startOfWeek;
            });
            
            const completedWeekTasks = weekTasks.filter(task => task.completed);
            
            return weekTasks.length > 0 ? (completedWeekTasks.length / weekTasks.length) * 100 : 0;
        }
        
        // 显示成就解锁动画
        function showAchievementUnlock(achievement) {
            // 创建背景遮罩
            const overlay = document.createElement('div');
            overlay.className = 'achievement-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                animation: overlayFadeIn 0.5s ease-out;
            `;
            
            // 创建成就弹窗
            const achievementPopup = document.createElement('div');
            achievementPopup.className = 'achievement-popup';
            achievementPopup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: achievementShow 4s ease-out forwards;
                max-width: 350px;
                width: 90%;
            `;
            
            // 创建粒子效果容器
            const particlesContainer = document.createElement('div');
            particlesContainer.className = 'particles-container';
            particlesContainer.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                overflow: hidden;
                border-radius: 20px;
            `;
            
            // 添加粒子效果
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: 6px;
                    height: 6px;
                    background: #ffd700;
                    border-radius: 50%;
                    animation: particleFloat ${2 + Math.random() * 2}s ease-out infinite;
                    animation-delay: ${Math.random() * 2}s;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                `;
                particlesContainer.appendChild(particle);
            }
            
            achievementPopup.innerHTML = `
                <div style="position: relative; z-index: 1;">
                    <div style="font-size: 64px; margin-bottom: 20px; animation: iconBounce 2s ease-out;">${achievement.icon}</div>
                    <h3 style="margin: 0 0 12px 0; font-size: 24px; animation: textSlideIn 1s ease-out 0.5s both;">🎉 成就解锁！</h3>
                    <h4 style="margin: 0 0 12px 0; color: #ffd700; font-size: 18px; animation: textSlideIn 1s ease-out 0.7s both;">${achievement.name}</h4>
                    <p style="margin: 0 0 20px 0; font-size: 14px; opacity: 0.9; line-height: 1.4; animation: textSlideIn 1s ease-out 0.9s both;">${achievement.description}</p>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 25px; display: inline-block; font-weight: bold; animation: pointsBounce 1s ease-out 1.2s both;">
                        +${achievement.points} 积分
                    </div>
                </div>
            `;
            
            achievementPopup.appendChild(particlesContainer);
            document.body.appendChild(overlay);
            document.body.appendChild(achievementPopup);
            
            // 4秒后自动移除
            setTimeout(() => {
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                if (achievementPopup.parentNode) achievementPopup.parentNode.removeChild(achievementPopup);
            }, 4000);
        }
        
        // 添加成就动画CSS
        function addAchievementAnimationCSS() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes overlayFadeIn {
                    0% { opacity: 0; }
                    100% { opacity: 1; }
                }
                
                @keyframes achievementShow {
                    0% { 
                        opacity: 0; 
                        transform: translate(-50%, -50%) scale(0.3) rotateY(180deg); 
                    }
                    20% { 
                        opacity: 1; 
                        transform: translate(-50%, -50%) scale(1.2) rotateY(0deg); 
                    }
                    30% { 
                        transform: translate(-50%, -50%) scale(0.95) rotateY(0deg); 
                    }
                    40% { 
                        transform: translate(-50%, -50%) scale(1.05) rotateY(0deg); 
                    }
                    50% { 
                        transform: translate(-50%, -50%) scale(1) rotateY(0deg); 
                    }
                    85% { 
                        opacity: 1; 
                        transform: translate(-50%, -50%) scale(1) rotateY(0deg); 
                    }
                    100% { 
                        opacity: 0; 
                        transform: translate(-50%, -50%) scale(0.8) rotateY(0deg); 
                    }
                }
                
                @keyframes iconBounce {
                    0% { 
                        transform: scale(0) rotate(0deg); 
                    }
                    50% { 
                        transform: scale(1.3) rotate(180deg); 
                    }
                    70% { 
                        transform: scale(0.9) rotate(360deg); 
                    }
                    100% { 
                        transform: scale(1) rotate(360deg); 
                    }
                }
                
                @keyframes textSlideIn {
                    0% { 
                        opacity: 0; 
                        transform: translateY(20px); 
                    }
                    100% { 
                        opacity: 1; 
                        transform: translateY(0); 
                    }
                }
                
                @keyframes pointsBounce {
                    0% { 
                        opacity: 0; 
                        transform: scale(0.5) translateY(20px); 
                    }
                    50% { 
                        opacity: 1; 
                        transform: scale(1.2) translateY(0); 
                    }
                    100% { 
                        opacity: 1; 
                        transform: scale(1) translateY(0); 
                    }
                }
                
                @keyframes particleFloat {
                    0% { 
                        opacity: 0; 
                        transform: translateY(0) scale(0); 
                    }
                    20% { 
                        opacity: 1; 
                        transform: translateY(-10px) scale(1); 
                    }
                    80% { 
                        opacity: 1; 
                        transform: translateY(-30px) scale(1); 
                    }
                    100% { 
                        opacity: 0; 
                        transform: translateY(-50px) scale(0); 
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 初始化应用
        function init() {
            // 首先检查并重置周期性任务
            resetPeriodicTasks();
            
            loadHomePage();
            addPointsAnimationCSS();
            addAchievementAnimationCSS();
            // 移除初始化时的成就检查，避免重复显示解锁提示
            initPermissionSystem(); // 初始化权限系统
            
            // 初始化任务管理功能
            if (currentUserMode === 'parent') {
                updateTaskManagementSummary();
                updateTaskPreview();
            }
        }
        
        // 添加积分动画CSS
        function addPointsAnimationCSS() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pointsAnimation {
                    0% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-30px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 页面切换功能
        function switchTab(tabName) {
            console.log('switchTab (line 2930) called with:', tabName);
            
            try {
                // 隐藏所有页面
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });
                
                // 移除所有导航项的active类
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 显示选中的页面
                const targetPage = document.getElementById(tabName + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                    targetPage.style.display = 'block';
                    console.log('显示页面:', tabName + 'Page');
                } else {
                    console.warn('找不到页面:', tabName + 'Page');
                }
                
                // 安全地添加active类到当前导航项
                try {
                    if (typeof event !== 'undefined' && event && event.target) {
                        const navItem = event.target.closest('.nav-item');
                        if (navItem) {
                            navItem.classList.add('active');
                        }
                    } else {
                        // 程序调用时，根据tabName找到对应的导航项
                        const navButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
                        if (navButton) {
                            navButton.classList.add('active');
                        }
                    }
                } catch (e) {
                    console.warn('设置导航项active状态时出错:', e);
                }
                
                // 根据页面加载相应数据
                switch(tabName) {
                    case 'home':
                        loadHomePage();
                        break;
                    case 'tasks':
                        loadTasks();
                        updateTaskDisplay(); // 应用智能过滤
                        break;
                    case 'stats':
                        loadStats();
                        break;
                    case 'shop':
                        loadShop();
                        break;
                    case 'profile':
                        loadProfile();
                        break;
                    case 'parent':
                        loadParentPage();
                        break;
                }
                
                console.log('switchTab (line 2930) 执行完成');
            } catch (error) {
                console.error('switchTab函数执行出错:', error);
            }
        }
        
        // 首页数据加载
        function loadHomePage() {
            // 更新用户信息
            document.getElementById('userName').textContent = userProfile.name;
            document.getElementById('userLevel').textContent = `Lv.${userProfile.level} ${getLevelTitle(userProfile.level)}`;
            document.getElementById('userAvatar').textContent = userProfile.avatar;
            document.getElementById('homePoints').textContent = totalPoints;
            
            // 更新月度统计
            const monthlyStats = getMonthlyStats();
            document.getElementById('monthlyTotalTasks').textContent = monthlyStats.totalTasks;
            document.getElementById('monthlyCompletedTasks').textContent = monthlyStats.completedTasks;
            document.getElementById('monthlyPendingTasks').textContent = monthlyStats.pendingTasks;
            document.getElementById('monthlyTotalPoints').textContent = monthlyStats.totalPoints;
            
            // 渲染首页任务列表
            renderHomeTaskList();
        }
        
        // 获取月度统计数据
        function getMonthlyStats() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let totalTasks = 0;
            let completedTasks = 0;
            let totalPoints = 0;
            
            // 计算本月任务统计
            tasks.forEach(task => {
                const taskDate = new Date(task.createdAt || now);
                if (taskDate.getMonth() === currentMonth && taskDate.getFullYear() === currentYear) {
                    totalTasks++;
                    if (task.completed) {
                        completedTasks++;
                        totalPoints += task.points || 10;
                    }
                }
            });
            
            return {
                totalTasks,
                completedTasks,
                pendingTasks: totalTasks - completedTasks,
                totalPoints
            };
        }
        

        
        // 获取等级称号
        function getLevelTitle(level) {
            if (level <= 5) return '新手';
            if (level <= 10) return '进阶者';
            if (level <= 20) return '自律达人';
            return '大师';
        }
        
        // ========== 智能任务过滤系统 ==========
        
        // 重置周期性任务
        function resetPeriodicTasks() {
            const now = new Date();
            const today = now.toDateString();
            
            // 获取上次重置检查的日期
            const lastResetCheck = localStorage.getItem('lastResetCheck');
            
            // 如果今天已经检查过，则跳过
            if (lastResetCheck === today) {
                return;
            }
            
            let hasReset = false;
            
            // 遍历所有任务，重置周期性任务
            tasks.forEach(task => {
                if (!task.completed) return; // 未完成的任务不需要重置
                
                const completedDate = new Date(task.completedAt || task.createdAt);
                let shouldReset = false;
                
                // 检查是否需要重置
                switch (task.frequency) {
                    case 'daily':
                        // 每日任务：如果完成日期不是今天，则重置
                        shouldReset = completedDate.toDateString() !== today;
                        break;
                        
                    case 'weekly':
                        // 每周任务：如果已过了一周，则重置
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay()); // 本周开始（周日）
                        weekStart.setHours(0, 0, 0, 0);
                        shouldReset = completedDate < weekStart;
                        break;
                        
                    case 'weekdays':
                        // 工作日任务：如果完成日期不是今天且今天是工作日，则重置
                        const dayOfWeek = now.getDay();
                        shouldReset = completedDate.toDateString() !== today && dayOfWeek >= 1 && dayOfWeek <= 5;
                        break;
                        
                    case 'weekends':
                        // 周末任务：如果完成日期不是今天且今天是周末，则重置
                        const isWeekend = now.getDay() === 0 || now.getDay() === 6;
                        shouldReset = completedDate.toDateString() !== today && isWeekend;
                        break;
                        
                    case 'monthly':
                        // 每月任务：如果已过了一个月，则重置
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        shouldReset = completedDate < monthStart;
                        break;
                }
                
                // 执行重置
                if (shouldReset) {
                    task.completed = false;
                    task.completedAt = null;
                    hasReset = true;
                    
                    // 从已完成任务列表中移除相关记录
                    completedTasks = completedTasks.filter(ct => ct.id !== task.id || 
                        new Date(ct.completedAt || ct.date).toDateString() === today);
                }
            });
            
            // 如果有任务被重置，保存数据并显示提示
            if (hasReset) {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                
                // 显示友好的重置提示
                setTimeout(() => {
                    showEnhancedToast('🔄 周期性任务已自动重置，新的挑战开始了！', 'info');
                }, 1000);
            }
            
            // 记录今天已经检查过
            localStorage.setItem('lastResetCheck', today);
        }
        
        // 获取今日任务（智能过滤）
        function getTodayTasks() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=周日, 1=周一, ..., 6=周六
            
            return tasks.filter(task => {
                // 每日任务
                if (task.frequency === 'daily') return true;
                
                // 工作日任务（周一到周五）
                if (task.frequency === 'weekdays' && dayOfWeek >= 1 && dayOfWeek <= 5) return true;
                
                // 周末任务（周六和周日）
                if (task.frequency === 'weekends' && (dayOfWeek === 0 || dayOfWeek === 6)) return true;
                
                // 特定星期几的任务
                if (task.frequency === 'weekly' && task.weekDay === dayOfWeek) return true;
                
                return false;
            });
        }
        
        // 获取今日已完成任务
        function getCompletedTodayTasks() {
            const today = new Date().toDateString();
            return completedTasks.filter(task => {
                const taskDate = new Date(task.completedAt || task.date).toDateString();
                return taskDate === today;
            });
        }
        
        // 获取所有任务
        function getAllTasks() {
            return tasks;
        }
        
        // 任务过滤功能
        function filterTasks(category = 'all') {
            let filteredTasks = tasks;
            
            if (category !== 'all') {
                filteredTasks = tasks.filter(task => task.category === category);
            }
            
            // 重新渲染任务列表 - 同时更新首页和任务页
            renderTaskList(filteredTasks);
            renderHomeTaskList(filteredTasks);
            
            // 更新分类按钮状态
            updateCategoryButtons(category);
        }
        
        // 渲染任务列表
        function renderTaskList(taskList = tasks) {
            const container = document.getElementById('taskList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无任务</div>';
                return;
            }
            
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            
            taskList.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                // 构建任务操作按钮
                let actionButtons = `
                    <button class="btn-complete" onclick="toggleTask('${task.id}')" 
                            ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? '🎉' : '💪'}
                    </button>
                `;
                
                // 家长模式下添加编辑和删除按钮
                if (currentMode === 'parent') {
                    actionButtons += `
                        <button class="btn-edit" onclick="editTask('${task.id}')" title="编辑任务">
                            ✏️
                        </button>
                        <button class="btn-delete" onclick="deleteTask('${task.id}')" title="删除任务">
                            🗑️
                        </button>
                    `;
                }
                
                // 格式化截止时间显示
                let deadlineText = '';
                if (task.deadline) {
                    const deadline = new Date(task.deadline);
                    const now = new Date();
                    const isOverdue = deadline < now && !task.completed;
                    
                    const dateStr = deadline.toLocaleDateString('zh-CN', {
                        month: 'short',
                        day: 'numeric'
                    });
                    const timeStr = deadline.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    deadlineText = `<span class="deadline ${isOverdue ? 'overdue' : ''}" title="截止时间">
                        ⏰ ${dateStr} ${timeStr}
                    </span>`;
                }
                
                taskItem.innerHTML = `
                    <div class="task-content">
                        <div class="task-icon">${getTaskTypeIcon(task.category)}</div>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                ${getTaskTypeName(task.category)} • ${task.points} 积分
                                ${deadlineText}
                            </div>
                        </div>
                    </div>
                    <div class="task-actions">
                        ${actionButtons}
                    </div>
                `;
                container.appendChild(taskItem);
            });
        }
        
        // 渲染首页任务列表
        function renderHomeTaskList(taskList = tasks) {
            const container = document.getElementById('homeTaskList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无任务</div>';
                return;
            }
            
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            
            taskList.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                // 构建任务操作按钮
                let actionButtons = `
                    <button class="btn-complete" onclick="toggleTask('${task.id}')" 
                            ${task.completed ? 'disabled' : ''}>
                        ${task.completed ? '🎉' : '💪'}
                    </button>
                `;
                
                // 家长模式下添加编辑和删除按钮
                if (currentMode === 'parent') {
                    actionButtons += `
                        <button class="btn-edit" onclick="editTask('${task.id}')" title="编辑任务">
                            ✏️
                        </button>
                        <button class="btn-delete" onclick="deleteTask('${task.id}')" title="删除任务">
                            🗑️
                        </button>
                    `;
                }
                
                // 格式化截止时间显示
                let deadlineText = '';
                if (task.deadline) {
                    const deadline = new Date(task.deadline);
                    const now = new Date();
                    const isOverdue = deadline < now && !task.completed;
                    
                    const dateStr = deadline.toLocaleDateString('zh-CN', {
                        month: 'short',
                        day: 'numeric'
                    });
                    const timeStr = deadline.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    deadlineText = `<span class="deadline ${isOverdue ? 'overdue' : ''}" title="截止时间">
                        ⏰ ${dateStr} ${timeStr}
                    </span>`;
                }
                
                taskItem.innerHTML = `
                    <div class="task-content">
                        <div class="task-icon">${getTaskTypeIcon(task.category)}</div>
                        <div class="task-info">
                            <div class="task-title">${task.title}</div>
                            <div class="task-meta">
                                ${getTaskTypeName(task.category)} • ${task.points} 积分
                                ${deadlineText}
                            </div>
                        </div>
                    </div>
                    <div class="task-actions">
                        ${actionButtons}
                    </div>
                `;
                container.appendChild(taskItem);
            });
        }
        
        // 更新分类按钮状态
        function updateCategoryButtons(activeCategory) {
            // 更新首页分类按钮
            const homeButtons = document.querySelectorAll('#homePage .category-btn');
            homeButtons.forEach(btn => {
                btn.classList.remove('active');
                const btnCategory = btn.onclick.toString().match(/filterTasks\('(.+?)'\)/);
                if (btnCategory && btnCategory[1] === activeCategory) {
                    btn.classList.add('active');
                }
            });
            
            // 更新任务页分类按钮
            const taskButtons = document.querySelectorAll('#tasksPage .category-btn');
            taskButtons.forEach(btn => {
                btn.classList.remove('active');
                const btnCategory = btn.onclick.toString().match(/filterTasks\('(.+?)'\)/);
                if (btnCategory && btnCategory[1] === activeCategory) {
                    btn.classList.add('active');
                }
            });
        }
        
        // 切换任务完成状态
        function toggleTask(taskId) {
            const task = tasks.find(t => t.id == taskId);
            if (!task) return;
            
            // 如果任务已完成，不允许重复完成
            if (task.completed) {
                showEnhancedToast('该任务已经完成了！', 'warning');
                return;
            }
            
            // 立即更新按钮状态，提供即时反馈
            const button = document.querySelector(`button[onclick="toggleTask('${taskId}')"]`);
            if (button) {
                button.disabled = true;
                button.classList.add('checking-in');
                button.innerHTML = '⏳';
                
                // 添加按钮点击动画
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = 'scale(1)';
                }, 150);
            }
            
            // 播放打卡音效（如果支持）
            playCheckInSound();
            
            // 延迟一点时间让用户看到反馈，然后处理逻辑
            setTimeout(() => {
                // 标记任务为完成
                task.completed = true;
                task.completedAt = new Date().toISOString();
                
                // 添加到已完成任务列表
                const completedTask = {
                    id: taskId,
                    title: task.title,
                    category: task.category || task.type,
                    points: task.points,
                    completedAt: task.completedAt,
                    date: new Date().toISOString(),
                    priority: task.priority || 'medium'
                };
                completedTasks.push(completedTask);
                
                // 增加积分
                totalPoints += task.points;
                
                // 立即更新按钮为完成状态
                if (button) {
                    button.classList.remove('checking-in');
                    button.classList.add('completed');
                    button.innerHTML = '✓';
                    button.disabled = false;
                    
                    // 添加成功动画效果
                    button.style.background = '#28a745';
                    button.style.color = 'white';
                    button.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        button.style.transform = 'scale(1)';
                    }, 200);
                }
                
                // 立即更新任务项的视觉状态
                const taskElement = button.closest('.task-item');
                if (taskElement) {
                    taskElement.classList.add('completed');
                    taskElement.style.opacity = '0.7';
                    
                    // 添加完成动画
                    taskElement.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        taskElement.style.transform = 'scale(1)';
                    }, 300);
                }
                
                // 显示增强的完成动画（包含所有信息，不需要额外的toast）
                showEnhancedTaskCompleteAnimation(task);
                
                // 保存数据
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                localStorage.setItem('totalPoints', totalPoints.toString());
                
                // 检查成就
                checkAchievements();
                
                // 延迟更新显示，让用户先看到即时反馈
                setTimeout(() => {
                    const currentPage = document.querySelector('.page[style*="block"]');
                    if (currentPage && currentPage.id === 'homePage') {
                        loadHomePage();
                    } else if (currentPage && currentPage.id === 'tasksPage') {
                        renderTaskList();
                    }
                    // 无论在哪个页面，都更新首页任务列表
                    renderHomeTaskList();
                }, 500);
                
            }, 300); // 300ms延迟让用户看到即时反馈
        }
        
        // 显示任务完成动画
        function showTaskCompleteAnimation(task) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                animation: taskCompleteShow 2s ease-out forwards;
            `;
            
            popup.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px;">🎉</div>
                <h3 style="margin: 0 0 8px 0;">任务完成！</h3>
                <p style="margin: 0; opacity: 0.9;">获得 ${task.points} 积分</p>
            `;
            
            document.body.appendChild(popup);
            
            // 添加动画样式
            if (!document.getElementById('taskCompleteAnimation')) {
                const style = document.createElement('style');
                style.id = 'taskCompleteAnimation';
                style.textContent = `
                    @keyframes taskCompleteShow {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 2000);
        }
        
        // 加载最新成就
        function loadRecentAchievements() {
            const container = document.getElementById('recentAchievements');
            if (!container) return;
            
            const unlockedAchievements = getUnlockedAchievements();
            const recentAchievements = unlockedAchievements.slice(-3); // 最近3个成就
            
            if (recentAchievements.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无成就</div>';
                return;
            }
            
            container.innerHTML = '';
            recentAchievements.forEach(achievement => {
                const achievementItem = document.createElement('div');
                achievementItem.className = 'achievement-item';
                achievementItem.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                    </div>
                `;
                container.appendChild(achievementItem);
            });
        }
        
        // 加载任务页面
        function loadTasks() {
            renderTaskList();
            updateTaskStats();
        }
        
        // 更新任务统计
        function updateTaskStats() {
            const todayTasks = getTodayTasks();
            const completedToday = getCompletedTodayTasks();
            
            // 更新任务分类按钮的数量显示
            const schoolTasks = tasks.filter(t => t.category === 'school').length;
            const homeTasks = tasks.filter(t => t.category === 'home').length;
            const tempTasks = tasks.filter(t => t.category === 'temp').length;
            
            // 这里可以添加更多统计信息的更新
        }
        
        // 更新任务显示（应用智能过滤）
        function updateTaskDisplay() {
            const todayTasks = getTodayTasks();
            renderTaskList(todayTasks);
        }
        
        // 加载统计页面
        function loadStats() {
            // 更新本周完成率
            const weeklyRate = calculateWeeklyCompletionRate();
            const weeklyElement = document.getElementById('weeklyCompletionRate');
            if (weeklyElement) {
                weeklyElement.textContent = weeklyRate + '%';
            }
            
            // 更新连续天数
            const streakElement = document.getElementById('streakDays');
            if (streakElement) {
                streakElement.textContent = userProfile.streakDays;
            }
            
            // 更新7天完成图表
            updateWeeklyChart();
        }
        
        // 更新7天完成图表
        function updateWeeklyChart() {
            const chartContainer = document.getElementById('weeklyChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // 生成最近7天的数据
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                
                const dayTasks = completedTasks.filter(task => {
                    const taskDate = new Date(task.completedAt || task.date).toDateString();
                    return taskDate === dateStr;
                }).length;
                
                const dayElement = document.createElement('div');
                dayElement.className = 'chart-day';
                dayElement.innerHTML = `
                    <div class="chart-bar" style="height: ${Math.max(dayTasks * 20, 5)}px;"></div>
                    <div class="chart-label">${date.getDate()}</div>
                `;
                chartContainer.appendChild(dayElement);
            }
        }
        
        // 加载商城页面
        function loadShop() {
            renderShopItems();
            updateShopPoints();
        }
        
        // 商城物品数据 - 从localStorage读取products数据
        function getShopItems() {
            return products || [];
        }
        
        // 当前选中的商城分类
        let currentShopCategory = 'all';
        
        // 渲染商城物品
        function renderShopItems(category = 'all') {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            // 根据分类筛选商品
            const shopItems = getShopItems();
            let filteredItems = shopItems;
            if (category !== 'all') {
                filteredItems = shopItems.filter(item => item.category === category);
            }
            
            container.innerHTML = '';
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🛒</div>
                        <p>该分类暂无商品</p>
                    </div>
                `;
                return;
            }
            
            filteredItems.forEach(item => {
                const canAfford = totalPoints >= item.price;
                const itemElement = document.createElement('div');
                itemElement.className = `shop-item ${!canAfford ? 'disabled' : ''}`;
                itemElement.innerHTML = `
                    <div class="shop-item-icon">${item.icon}</div>
                    <div class="shop-item-content">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-desc">${item.description}</div>
                        <div class="shop-item-price">${item.price} 积分</div>
                    </div>
                    <button class="btn-buy ${!canAfford ? 'disabled' : ''}" 
                            onclick="buyItem('${item.id}', '${item.name}', ${item.price})"
                            ${!canAfford ? 'disabled' : ''}>
                        ${!canAfford ? '积分不足' : '兑换'}
                    </button>
                `;
                container.appendChild(itemElement);
            });
        }
        
        // 购买物品
        function buyItem(itemId, itemName, price) {
            if (totalPoints < price) {
                showToast('❌ 积分不足！');
                return;
            }
            
            // 确认购买
            if (!confirm(`确定要用 ${price} 积分兑换"${itemName}"吗？`)) {
                return;
            }
            
            // 扣除积分
            totalPoints -= price;
            localStorage.setItem('totalPoints', totalPoints.toString());
            
            // 记录兑换历史
            const exchanges = JSON.parse(localStorage.getItem('exchanges') || '[]');
            const exchange = {
                id: 'exchange_' + Date.now(),
                itemId: itemId,
                itemName: itemName,
                price: price,
                date: new Date().toISOString(),
                status: 'pending' // pending, completed, cancelled
            };
            exchanges.push(exchange);
            localStorage.setItem('exchanges', JSON.stringify(exchanges));
            
            // 显示成功提示
            showToast(`🎉 兑换成功！已扣除 ${price} 积分`);
            
            // 重新加载商城和更新积分显示
            loadShop();
            
            // 如果在首页，更新积分显示
            const currentPage = document.querySelector('.page[style*="block"]');
            if (currentPage && currentPage.id === 'homePage') {
                loadHomePage();
            }
        }
        
        // 商城分类筛选
        function filterShop(category) {
            currentShopCategory = category;
            
            // 更新分类按钮状态
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 重新渲染商品
            renderShopItems(category);
        }
        
        // 更新商城积分显示
        function updateShopPoints() {
            const balanceElement = document.getElementById('userBalance');
            if (balanceElement) {
                balanceElement.textContent = totalPoints;
            }
        }
        
        // 查看兑换历史
        function viewExchangeHistory() {
            const exchanges = JSON.parse(localStorage.getItem('exchanges') || '[]');
            
            if (exchanges.length === 0) {
                showToast('暂无兑换记录');
                return;
            }
            
            let historyHtml = '<div class="exchange-history-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">';
            historyHtml += '<div style="background: white; border-radius: 15px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;">';
            historyHtml += '<h3 style="margin: 0 0 15px 0; text-align: center;">兑换历史</h3>';
            
            exchanges.reverse().forEach(exchange => {
                const date = new Date(exchange.date).toLocaleDateString('zh-CN');
                const statusText = exchange.status === 'pending' ? '待处理' : exchange.status === 'completed' ? '已完成' : '已取消';
                const statusColor = exchange.status === 'pending' ? '#f39c12' : exchange.status === 'completed' ? '#27ae60' : '#e74c3c';
                
                historyHtml += `
                    <div style="border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold;">${exchange.itemName}</div>
                                <div style="color: #666; font-size: 12px;">${date}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #e74c3c; font-weight: bold;">-${exchange.price} 积分</div>
                                <div style="color: ${statusColor}; font-size: 12px;">${statusText}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyHtml += '<button onclick="closeExchangeHistory()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; margin-top: 15px;">关闭</button>';
            historyHtml += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', historyHtml);
        }
        
        // 关闭兑换历史弹窗
        function closeExchangeHistory() {
            const modal = document.querySelector('.exchange-history-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 加载个人中心
        function loadProfile() {
            // 更新用户信息显示
            const nameElement = document.getElementById('profileName');
            const levelElement = document.getElementById('profileLevel');
            const pointsElement = document.getElementById('profilePoints');
            const avatarElement = document.getElementById('profileAvatar');
            
            if (nameElement) nameElement.textContent = userProfile.name;
            if (levelElement) levelElement.textContent = `Lv.${userProfile.level} ${getLevelTitle(userProfile.level)}`;
            if (pointsElement) pointsElement.textContent = totalPoints;
            if (avatarElement) avatarElement.textContent = userProfile.avatar;
            
            // 更新统计信息
            const totalTasksElement = document.getElementById('profileTotalTasks');
            const completedTasksElement = document.getElementById('profileCompletedTasks');
            const streakDaysElement = document.getElementById('profileStreakDays');
            
            if (totalTasksElement) totalTasksElement.textContent = getAllTasks().length;
            if (completedTasksElement) completedTasksElement.textContent = completedTasks.length;
            if (streakDaysElement) streakDaysElement.textContent = userProfile.streakDays;
        }
        
        // 编辑用户资料
        function editProfile() {
            // 显示编辑资料模态框
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                // 填充当前用户信息
                document.getElementById('editUserName').value = userProfile.name;
                document.getElementById('editUserAvatar').value = userProfile.avatar;
                document.getElementById('selectedAvatarDisplay').textContent = userProfile.avatar;
                
                // 设置当前头像的选中状态
                selectAvatar(userProfile.avatar);
                
                modal.style.display = 'block';
                document.getElementById('editUserName').focus();
            } else {
                showToast('❌ 编辑功能暂时不可用');
            }
        }
        
        // 隐藏编辑资料模态框
        function hideEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                modal.style.display = 'none';
                // 清空表单
                document.getElementById('editUserName').value = '';
                document.getElementById('editUserAvatar').value = '';
            }
        }
        
        // 选择头像
        function selectAvatar(avatar) {
            // 更新隐藏输入框的值
            document.getElementById('editUserAvatar').value = avatar;
            
            // 更新显示
            document.getElementById('selectedAvatarDisplay').textContent = avatar;
            
            // 更新选中状态
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 找到并选中当前头像
            const selectedOption = Array.from(document.querySelectorAll('.avatar-option')).find(option => 
                option.textContent === avatar
            );
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }

        // 保存用户资料
        function saveUserProfile() {
            const newName = document.getElementById('editUserName').value.trim();
            const newAvatar = document.getElementById('editUserAvatar').value.trim();
            
            if (!newName) {
                showToast('❌ 请输入用户名');
                return;
            }
            
            if (!newAvatar) {
                showToast('❌ 请选择头像');
                return;
            }
            
            // 更新用户资料
            userProfile.name = newName;
            userProfile.avatar = newAvatar;
            
            // 保存到本地存储
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            // 更新页面显示
            document.getElementById('userName').textContent = newName;
            document.getElementById('userAvatar').textContent = newAvatar;
            
            // 如果在个人中心页面，也更新那里的显示
            const profileName = document.getElementById('profileName');
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileName) profileName.textContent = newName;
            if (profileAvatar) profileAvatar.textContent = newAvatar;
            
            // 隐藏模态框
            hideEditProfileModal();
            
            showToast('✅ 资料更新成功');
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                z-index: 10000;
                font-size: 14px;
                animation: toastShow 3s ease-out forwards;
            `;
            toast.textContent = message;
            
            // 添加动画样式
            if (!document.getElementById('toastAnimation')) {
                const style = document.createElement('style');
                style.id = 'toastAnimation';
                style.textContent = `
                    @keyframes toastShow {
                        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // 增强的Toast提示函数
        function showEnhancedToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `enhanced-toast ${type}`;
            
            // 根据类型设置图标和颜色
            let icon = '';
            let bgColor = '';
            switch(type) {
                case 'success':
                    icon = '🎉';
                    bgColor = 'linear-gradient(135deg, #28a745, #20c997)';
                    break;
                case 'warning':
                    icon = '⚠️';
                    bgColor = 'linear-gradient(135deg, #ffc107, #fd7e14)';
                    break;
                case 'error':
                    icon = '❌';
                    bgColor = 'linear-gradient(135deg, #dc3545, #e83e8c)';
                    break;
                default:
                    icon = 'ℹ️';
                    bgColor = 'linear-gradient(135deg, #17a2b8, #6f42c1)';
            }
            
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: ${bgColor};
                color: white;
                padding: 20px 30px;
                border-radius: 15px;
                z-index: 10001;
                font-size: 16px;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                min-width: 280px;
                transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span style="font-size: 24px;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // 添加进入动画
            setTimeout(() => {
                toast.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 50);
            
            // 自动消失
            setTimeout(() => {
                toast.style.transform = 'translate(-50%, -50%) scale(0)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, type === 'success' ? 2500 : 2000);
        }

        // 播放打卡音效函数
        function playCheckInSound() {
            try {
                // 创建音频上下文（如果支持）
                if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
                    const audioContext = new (AudioContext || webkitAudioContext)();
                    
                    // 创建简单的成功音效
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                }
            } catch (error) {
                // 如果音频不支持，静默失败
                console.log('Audio not supported');
            }
        }

        // 增强的任务完成动画
        function showEnhancedTaskCompleteAnimation(task) {
            // 创建更显眼的完成动画
            const animation = document.createElement('div');
            animation.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 30px;
                border-radius: 20px;
                z-index: 10002;
                text-align: center;
                box-shadow: 0 15px 40px rgba(0,0,0,0.3);
                transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            animation.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <div style="
                        width: 60px; 
                        height: 60px; 
                        border-radius: 50%; 
                        background: rgba(255,255,255,0.2); 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        font-size: 30px;
                        animation: checkmarkBounce 0.6s ease-out;
                    ">🎉</div>
                    <div style="font-size: 18px; font-weight: 600;">打卡成功！</div>
                    <div style="font-size: 16px; margin: 5px 0; max-width: 250px; word-wrap: break-word;">"${task.title}"</div>
                    <div style="font-size: 14px; opacity: 0.9;">获得 ${task.points} 积分</div>
                </div>
            `;
            
            // 添加动画样式
            if (!document.getElementById('checkmarkAnimation')) {
                const style = document.createElement('style');
                style.id = 'checkmarkAnimation';
                style.textContent = `
                    @keyframes checkmarkBounce {
                        0% { transform: scale(0); }
                        50% { transform: scale(1.2); }
                        100% { transform: scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(animation);
            
            // 触发动画
            setTimeout(() => {
                animation.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 100);
            
            // 移除动画
            setTimeout(() => {
                animation.style.transform = 'translate(-50%, -50%) scale(0)';
                setTimeout(() => {
                    if (document.body.contains(animation)) {
                        document.body.removeChild(animation);
                    }
                }, 400);
            }, 1800);
        }
        
        // 获取任务类型图标
        function getTaskTypeIcon(category) {
            const icons = {
                'school': '📚',
                'home': '🏠',
                'temp': '⏰',
                'daily': '📅',
                'weekly': '📆',
                'weekdays': '📝',
                'weekends': '🎮'
            };
            return icons[category] || '📋';
        }
        
        // 获取任务类型名称
        function getTaskTypeName(category) {
            const names = {
                'school': '学校任务',
                'home': '家庭任务',
                'temp': '临时任务',
                'daily': '每日任务',
                'weekly': '每周任务',
                'weekdays': '工作日任务',
                'weekends': '周末任务'
            };
            return names[category] || '其他任务';
        }
        
        // 添加任务模态框功能
        function showAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                modal.style.display = 'flex';
                // 清空表单
                document.getElementById('taskName').value = '';
                document.getElementById('taskType').value = 'school';
                document.getElementById('taskPoints').value = '10';
            }
        }
        
        function hideAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        

        
        // 权限系统相关变量
        let currentUserMode = localStorage.getItem('currentUserMode') || 'student';
        
        // 更新用户模式显示
        function updateUserModeDisplay() {
            const modeIndicator = document.getElementById('currentModeIndicator');
            if (modeIndicator) {
                modeIndicator.textContent = currentUserMode === 'parent' ? '家长模式' : '学生模式';
                modeIndicator.style.color = currentUserMode === 'parent' ? '#dc3545' : '#007bff';
            }
        }
        
        // 显示模式切换对话框

        
        // 根据用户模式更新UI

        
        // 显示任务完成动画
        function showTaskCompleteAnimation(taskItem, points) {
            const animation = document.createElement('div');
            animation.textContent = `+${points}积分`;
            animation.style.cssText = `
                position: absolute;
                right: 20px;
                color: #34c759;
                font-weight: bold;
                font-size: 16px;
                pointer-events: none;
                animation: pointsAnimation 1s ease-out forwards;
            `;
            
            taskItem.style.position = 'relative';
            taskItem.appendChild(animation);
            
            setTimeout(() => {
                animation.remove();
            }, 1000);
        }
        
        // 加载最新成就
        function loadRecentAchievements() {
            const achievementsContainer = document.getElementById('recentAchievements');
            const achievements = getUnlockedAchievements();
            
            if (achievements.length === 0) {
                achievementsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🏆</div>
                        <p>暂无成就，完成任务解锁更多成就！</p>
                    </div>
                `;
            } else {
                achievementsContainer.innerHTML = achievements.slice(0, 3).map(achievement => `
                    <div class="achievement-item unlocked">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-info">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        

        
        // 获取任务类型图标
        function getTaskTypeIcon(type) {
            const icons = {
                study: '📚',
                exercise: '🏃',
                reading: '📖',
                habit: '✨',
                other: '🎯'
            };
            return icons[type] || '🎯';
        }
        
        // 获取任务类型名称
        function getTaskTypeName(type) {
            const names = {
                study: '学习',
                exercise: '运动',
                reading: '阅读',
                habit: '习惯',
                other: '其他'
            };
            return names[type] || '其他';
        }
        

        
        // 显示添加任务模态框
        function showAddTaskModal() {
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            const pointsInput = document.getElementById('taskPoints');
            const hint = document.querySelector('.points-hint');
            
            // 根据用户模式设置积分字段
            if (currentMode === 'student') {
                pointsInput.value = '1';
                pointsInput.disabled = true;
                pointsInput.style.backgroundColor = '#f5f5f5';
                pointsInput.style.color = '#999';
                hint.textContent = '学生模式下积分固定为1分';
            } else {
                pointsInput.value = '1';
                pointsInput.disabled = false;
                pointsInput.style.backgroundColor = '';
                pointsInput.style.color = '';
                hint.textContent = '家长模式下可设置1-10分';
            }
            
            document.getElementById('addTaskModal').style.display = 'block';
            document.getElementById('taskTitle').focus();
        }
        
        // 隐藏添加任务模态框
        function hideAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskPoints').value = '1';
            
            // 重置积分输入框状态
            const pointsInput = document.getElementById('taskPoints');
            pointsInput.disabled = false;
            pointsInput.style.backgroundColor = '';
            pointsInput.style.color = '';
            
            // 清空提示文本
            const hint = document.querySelector('.points-hint');
            if (hint) {
                hint.textContent = '';
            }
        }
        

        
        // 保存任务到本地存储
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        // 切换底部导航
        function switchTab(tab) {
            // 移除所有active类
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 添加active类到当前选中的tab（如果是通过点击触发的）
            if (typeof event !== 'undefined' && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            } else {
                // 程序调用时，根据tab名称找到对应的nav-item
                const navItem = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                if (navItem) {
                    navItem.closest('.nav-item').classList.add('active');
                }
            }
            
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            
            // 显示对应页面
            const targetPage = document.getElementById(tab + 'Page');
            if (targetPage) {
                targetPage.style.display = 'block';
                
                // 根据页面类型执行特定逻辑
                if (tab === 'stats') {
                    renderStatsPage();
                } else if (tab === 'shop') {
                    renderShopPage();
                } else if (tab === 'profile') {
                    renderProfilePage();
                }
            }
        }
        
        // 渲染统计页面
        function renderStatsPage() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const completedTasks = tasks.filter(task => task.completed);
            const totalTasks = tasks.length;
            
            // 计算本周完成率
            const weeklyRate = totalTasks > 0 ? Math.round((completedTasks.length / totalTasks) * 100) : 0;
            document.getElementById('weeklyRate').textContent = weeklyRate + '%';
            document.getElementById('weeklyCompleted').textContent = completedTasks.length;
            
            // 计算连续打卡天数
            const streakDays = calculateStreakDays();
            document.getElementById('streakDays').textContent = streakDays;
            
            // 渲染图表
            renderWeeklyChart();
            
            // 渲染历史记录
            renderHistory();
        }
        
        // 计算连续打卡天数
        function calculateStreakDays() {
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const completedDates = [...new Set(
                tasks.filter(task => task.completed)
                     .map(task => new Date(task.createdAt).toDateString())
            )].sort((a, b) => new Date(b) - new Date(a));
            
            if (completedDates.length === 0) return 0;
            
            let streak = 1;
            const today = new Date().toDateString();
            
            if (completedDates[0] !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (completedDates[0] !== yesterday.toDateString()) {
                    return 0;
                }
            }
            
            for (let i = 1; i < completedDates.length; i++) {
                const current = new Date(completedDates[i-1]);
                const previous = new Date(completedDates[i]);
                const diffDays = (current - previous) / (1000 * 60 * 60 * 24);
                
                if (diffDays === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }
        
        // 渲染周图表
        function renderWeeklyChart() {
            const chartContainer = document.getElementById('weeklyChart');
            chartContainer.innerHTML = '';
            
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const dayTasks = tasks.filter(task => 
                    new Date(task.createdAt).toDateString() === dateStr && task.completed
                ).length;
                
                last7Days.push({
                    day: date.toLocaleDateString('zh-CN', { weekday: 'short' }),
                    count: dayTasks
                });
            }
            
            const maxCount = Math.max(...last7Days.map(d => d.count), 1);
            
            last7Days.forEach(dayData => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${(dayData.count / maxCount) * 180 + 20}px`;
                
                const dayLabel = document.createElement('div');
                dayLabel.className = 'chart-day';
                dayLabel.textContent = dayData.day;
                bar.appendChild(dayLabel);
                
                chartContainer.appendChild(bar);
            });
        }
        
        // 渲染历史记录
        function renderHistory() {
            const historyContainer = document.getElementById('historyList');
            historyContainer.innerHTML = '';
            
            const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
            const dailyStats = {};
            
            tasks.forEach(task => {
                if (task.completed) {
                    const date = new Date(task.createdAt).toLocaleDateString('zh-CN');
                    dailyStats[date] = (dailyStats[date] || 0) + 1;
                }
            });
            
            const sortedDates = Object.keys(dailyStats).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                historyContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <p>暂无完成记录</p>
                    </div>
                `;
                return;
            }
            
            sortedDates.slice(0, 10).forEach(date => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-count">${dailyStats[date]} 个任务</div>
                `;
                historyContainer.appendChild(item);
            });
        }
        
        // 渲染商城页面
        function renderShopPage() {
            const points = tasks.filter(task => task.completed).reduce((sum, task) => sum + task.points, 0);
            document.getElementById('userBalance').textContent = points;
            
            // 重置分类为全部
            currentShopCategory = 'all';
            renderShopItems('all');
        }
        

        
        // 商城分类筛选
        function filterShop(category) {
            currentShopCategory = category;
            
            // 更新分类按钮状态
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 重新渲染商品
            renderShopItems(category);
        }
        
        // 渲染个人中心页面
        function renderProfilePage() {
            const totalTasks = tasks.length;
            const totalPoints = tasks.filter(task => task.completed).reduce((sum, task) => sum + task.points, 0);
            
            document.getElementById('profileTotalTasks').textContent = totalTasks;
            document.getElementById('profileTotalPoints').textContent = totalPoints;
        }
        
        // 个人中心菜单功能
        function showSettings() {
            showToast('⚙️ 设置功能开发中...');
        }
        

        
        // 当前选择的优先级
        let selectedPriority = 'medium';
        

        
        // 选择优先级
        function selectPriority(priority) {
            selectedPriority = priority;
            
            // 更新优先级按钮状态
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const priorityBtn = document.querySelector(`[data-priority="${priority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active');
            }
        }
        
        // 增强的添加任务函数
        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const category = document.getElementById('taskCategory').value;
            const frequency = document.getElementById('taskFrequency').value;
            const points = parseInt(document.getElementById('taskPoints').value);
            const deadlineDate = document.getElementById('taskDeadlineDate').value;
            const deadlineTime = document.getElementById('taskDeadlineTime').value;
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            
            // 组合日期和时间
            let deadline = null;
            if (deadlineDate) {
                deadline = deadlineDate + (deadlineTime ? 'T' + deadlineTime : 'T23:59');
            }
            
            if (!title) {
                showToast('❌ 请输入任务名称');
                return;
            }
            
            // 根据用户模式验证积分
            if (currentMode === 'student') {
                // 学生模式下积分固定为1分
                if (points !== 1) {
                    showToast('❌ 学生模式下积分固定为1分');
                    return;
                }
            } else {
                // 家长模式下积分范围1-10分
                if (points < 1 || points > 10) {
                    showToast('❌ 家长模式下积分必须在1-10分之间');
                    return;
                }
            }
            
            // 检查临时任务是否设置了截止日期
            if (frequency === 'temporary' && !deadlineDate) {
                showToast('❌ 临时任务需要设置截止日期');
                return;
            }
            
            const newTask = {
                id: 'task_' + Date.now(),
                title: title,
                category: category,
                frequency: frequency,
                points: points,
                priority: selectedPriority,
                completed: false,
                createdAt: new Date().toISOString(),
                createdBy: currentMode,
                deadline: deadline || null
            };
            
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            hideAddTaskModal();
            loadTasks();
            renderHomeTaskList(); // 更新首页任务列表
            showToast('✅ 任务添加成功！');
        }
        
        // 显示添加任务模态框
        function showAddTaskModal() {
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            
            // 重置表单
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskCategory').value = 'school';
            document.getElementById('taskFrequency').value = 'daily';
            document.getElementById('taskDeadlineDate').value = '';
            document.getElementById('taskDeadlineTime').value = '23:59';
            
            // 根据用户模式设置积分字段
            const pointsInput = document.getElementById('taskPoints');
            const hint = document.querySelector('.points-hint');
            
            if (currentMode === 'student') {
                pointsInput.value = '1';
                pointsInput.disabled = true;
                pointsInput.style.backgroundColor = '#f5f5f5';
                pointsInput.style.color = '#999';
                hint.textContent = '学生模式下积分固定为1分';
            } else {
                pointsInput.value = '1';
                pointsInput.disabled = false;
                pointsInput.style.backgroundColor = '';
                pointsInput.style.color = '';
                hint.textContent = '家长模式下可设置1-10分，默认1分';
            }
            
            // 重置优先级选择
            selectPriority('medium');
            
            // 显示模态框
            document.getElementById('addTaskModal').style.display = 'block';
            
            // 监听频率变化，显示/隐藏截止日期
            document.getElementById('taskFrequency').addEventListener('change', function() {
                const temporaryGroup = document.getElementById('temporaryTaskGroup');
                if (this.value === 'temporary') {
                    temporaryGroup.style.display = 'block';
                } else {
                    temporaryGroup.style.display = 'none';
                }
            });
        }
        
        // 隐藏添加任务模态框
        function hideAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
        }
        
        // 增强的任务渲染函数
        function renderTaskList(tasksToRender) {
            const taskList = document.querySelector('.task-list');
            taskList.innerHTML = '';
            
            if (tasksToRender.length === 0) {
                taskList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <p>暂无任务</p>
                    </div>
                `;
                return;
            }
            
            // 按优先级排序任务
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            tasksToRender.sort((a, b) => {
                const aPriority = priorityOrder[a.priority || 'medium'];
                const bPriority = priorityOrder[b.priority || 'medium'];
                return bPriority - aPriority;
            });
            
            tasksToRender.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskElement.setAttribute('data-category', task.category);
                taskElement.setAttribute('data-priority', task.priority || 'medium');
                
                const icon = getTaskTypeIcon(task.category);
                const frequencyText = getFrequencyText(task.frequency);
                const priorityIcon = getPriorityIcon(task.priority || 'medium');
                
                taskElement.innerHTML = `
                    <div class="task-icon ${task.category}">${icon}</div>
                    <div class="task-content">
                        <div class="task-name">${task.title}</div>
                        <div class="task-meta">
                            <span>${frequencyText}</span>
                            <span class="task-points">+${task.points}积分</span>
                            <span class="task-priority">${priorityIcon}</span>
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="check-btn ${task.completed ? 'completed' : ''}" onclick="toggleTask('${task.id}')">
                            ${task.completed ? '✓' : '○'}
                        </button>
                        ${localStorage.getItem('currentUserMode') === 'parent' ? `
                            <button class="btn-edit" onclick="editTask('${task.id}')" title="编辑任务">
                                ✏️
                            </button>
                            <button class="btn-delete" onclick="deleteTask('${task.id}')" title="删除任务">
                                🗑️
                            </button>
                        ` : ''}
                    </div>
                `;
                
                taskList.appendChild(taskElement);
            });
        }
        
        // 获取频率文本
        function getFrequencyText(frequency) {
            const frequencyMap = {
                daily: '每日任务',
                weekly: '每周任务',
                weekend: '周末任务',
                current_week: '本周任务',
                temporary: '临时任务'
            };
            return frequencyMap[frequency] || '每日任务';
        }
        
        // 获取优先级图标
        function getPriorityIcon(priority) {
            const priorityMap = {
                high: '🔴',
                medium: '🟡',
                low: '🟢'
            };
            return priorityMap[priority] || '🟡';
        }
        
        function showAchievements() {
            const unlockedAchievements = getUnlockedAchievements();
            const allAchievements = achievements;
            
            let achievementHtml = '<div class="achievement-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">';
            achievementHtml += '<div style="background: white; border-radius: 15px; padding: 20px; max-width: 90%; max-height: 80%; overflow-y: auto; width: 400px;">';
            achievementHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">';
            achievementHtml += '<h3 style="margin: 0; color: #333;">🏆 成就系统</h3>';
            achievementHtml += '<button onclick="closeAchievementModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>';
            achievementHtml += '</div>';
            
            // 成就统计
            const unlockedCount = unlockedAchievements.length;
            const totalCount = allAchievements.length;
            const completionRate = Math.round((unlockedCount / totalCount) * 100);
            
            achievementHtml += '<div style="background: white; color: #1C1C1E; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid #E5E5EA; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">';
            achievementHtml += `<div style="font-size: 24px; font-weight: bold;">${unlockedCount}/${totalCount}</div>`;
            achievementHtml += `<div style="font-size: 14px; opacity: 0.9;">完成度 ${completionRate}%</div>`;
            achievementHtml += '</div>';
            
            // 成就列表
            achievementHtml += '<div style="max-height: 300px; overflow-y: auto;">';
            
            allAchievements.forEach(achievement => {
                const isUnlocked = unlockedAchievements.includes(achievement.id);
                const opacity = isUnlocked ? '1' : '0.5';
                const bgColor = isUnlocked ? '#f8f9fa' : '#f5f5f5';
                const iconFilter = isUnlocked ? '' : 'grayscale(1)';
                
                achievementHtml += `
                    <div style="display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background: ${bgColor}; border-radius: 8px; opacity: ${opacity}; border: ${isUnlocked ? '2px solid #ffd700' : '1px solid #ddd'};">
                        <div style="font-size: 32px; margin-right: 15px; filter: ${iconFilter};">${achievement.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: ${isUnlocked ? '#333' : '#999'};">${achievement.name}</div>
                            <div style="font-size: 12px; color: ${isUnlocked ? '#666' : '#999'}; margin: 4px 0;">${achievement.description}</div>
                            <div style="font-size: 12px; color: #f59e0b; font-weight: bold;">+${achievement.points} 积分</div>
                        </div>
                        ${isUnlocked ? '<div style="color: #27ae60; font-size: 20px;">✓</div>' : '<div style="color: #ccc; font-size: 16px;">🔒</div>'}
                    </div>
                `;
            });
            
            achievementHtml += '</div>';
            achievementHtml += '<button onclick="closeAchievementModal()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">关闭</button>';
            achievementHtml += '</div></div>';
            
            document.body.insertAdjacentHTML('beforeend', achievementHtml);
        }
        
        // 关闭成就弹窗
        function closeAchievementModal() {
            const modal = document.querySelector('.achievement-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function showHelp() {
            showToast('❓ 帮助功能开发中...');
        }
        
        function showAbout() {
            alert('📅 每日打卡 v1.0\n\n一个简单的任务管理应用，帮助你培养良好的习惯。\n\n功能特色：\n• 任务管理\n• 积分系统\n• 数据统计\n• 积分商城');
        }
        
        function exportData() {
            const data = {
                // 基础数据
                userProfile: userProfile,
                totalPoints: totalPoints,
                completedTasks: completedTasks,
                
                // 任务数据
                tasks: getAllTasks(),
                
                // 成就数据
                unlockedAchievements: getUnlockedAchievements(),
                
                // 权限设置
                userMode: localStorage.getItem('userMode') || 'student',
                
                // 商城数据
                exchanges: JSON.parse(localStorage.getItem('exchanges') || '[]'),
                
                // 统计数据
                statistics: {
                    weeklyCompletionRate: calculateWeeklyCompletionRate(),
                    streakDays: userProfile.streakDays,
                    totalTasksCreated: getAllTasks().length,
                    totalTasksCompleted: completedTasks.length
                },
                
                // 导出信息
                exportDate: new Date().toISOString(),
                appVersion: '1.0.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `每日打卡数据-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('📤 数据导出成功！文件已保存到下载文件夹');
        }
        
        function clearData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！\n\n建议在清空前先导出数据备份。')) {
                // 清空所有本地存储数据
                localStorage.removeItem('tasks');
                localStorage.removeItem('exchanges');
                localStorage.removeItem('totalPoints');
                localStorage.removeItem('completedTasks');
                localStorage.removeItem('userProfile');
                localStorage.removeItem('unlockedAchievements');
                localStorage.removeItem('userMode');
                localStorage.removeItem('currentUserMode');
                localStorage.removeItem('parentPassword');
                
                // 重置应用状态
                tasks = [];
                totalPoints = 0;
                completedTasks = [];
                userProfile = {
                    name: '小明',
                    level: 1,
                    avatar: '👤',
                    streakDays: 0
                };
                currentUserMode = 'student';
                
                // 更新界面
                updateStats();
                renderTasks();
                loadHomePage();
                updateUserModeDisplay();
                
                showToast('🗑️ 所有数据已清空！应用已重置到初始状态');
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            // 创建toast元素
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                text-align: center;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3秒后移除
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
        
        // 点击模态框外部关闭
        document.getElementById('addTaskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddTaskModal();
            }
        });
        
        // ========== 权限管理系统 ==========
        
        // 权限管理状态
        // currentUserMode 已在前面声明
        parentPassword = localStorage.getItem('parentPassword') || '123456'; // 默认家长密码
        
        // 显示模式切换弹窗或家长管理中心
        function showModeSwitch() {
            // 如果当前是家长模式，直接进入家长管理中心
            if (currentUserMode === 'parent') {
                switchTab('parent');
                return;
            }
            
            // 如果是学生模式，显示切换到家长模式的弹窗
            const modal = document.getElementById('modeSwitchModal');
            const title = modal.querySelector('.mode-switch-title');
            const passwordInput = document.getElementById('parentPassword');
            
            title.textContent = '切换到家长模式';
            passwordInput.placeholder = '请输入家长密码';
            passwordInput.style.display = 'block';
            passwordInput.value = '';
            passwordInput.focus();
            
            modal.style.display = 'flex';
        }
        
        // 直接切换到学生模式（从家长模式）
        function switchToStudentMode() {
            if (currentUserMode === 'parent') {
                currentUserMode = 'student';
                localStorage.setItem('currentUserMode', currentUserMode);
                updateUserModeDisplay();
                updateUIForUserMode();
                showToast('✅ 已切换到学生模式');
            }
        }
        
        // 隐藏模式切换弹窗
        function hideModeSwitch() {
            console.log('=== hideModeSwitch() 函数被调用 ===');
            
            const modal = document.getElementById('modeSwitchModal');
            if (modal) {
                console.log('找到modeSwitchModal元素，当前display状态:', modal.style.display);
                modal.style.display = 'none';
                console.log('已设置modeSwitchModal.style.display = "none"');
                console.log('设置后的display状态:', modal.style.display);
            } else {
                console.log('错误：找不到modeSwitchModal元素');
            }
            
            const parentPassword = document.getElementById('parentPassword');
            if (parentPassword) {
                parentPassword.style.display = 'block';
                console.log('已设置parentPassword.style.display = "block"');
            } else {
                console.log('警告：找不到parentPassword元素');
            }
            
            console.log('=== hideModeSwitch() 函数执行完成 ===');
        }
        
        // 确认模式切换
        function confirmModeSwitch() {
            console.log('=== confirmModeSwitch() 函数开始执行 ===');
            
            // 强制关闭弹窗 - 第一重保险
            console.log('强制关闭弹窗...');
            const modal = document.getElementById('modeSwitchModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('弹窗已强制关闭');
            } else {
                console.log('警告：找不到modeSwitchModal元素');
            }
            
            console.log('当前模式:', currentUserMode);
            console.log('parentPassword:', parentPassword);
            
            if (currentUserMode === 'student') {
                // 切换到家长模式，需要验证密码
                console.log('尝试从学生模式切换到家长模式');
                const passwordInput = document.getElementById('parentPassword');
                const inputPassword = passwordInput.value;
                console.log('输入的密码:', inputPassword);
                
                if (inputPassword === parentPassword) {
                    currentUserMode = 'parent';
                    localStorage.setItem('currentUserMode', currentUserMode);
                    updateUserModeDisplay();
                    switchTab('parent');
                    hideModeSwitch();
                    showToast('✅ 已切换到家长模式');
                } else {
                    showToast('❌ 密码错误，请重试');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } else {
                // 切换到学生模式，无需密码
                console.log('从家长模式切换到学生模式，无需密码验证');
                console.log('切换前的模式:', currentUserMode);
                
                currentUserMode = 'student';
                console.log('切换后的模式:', currentUserMode);
                
                localStorage.setItem('currentUserMode', currentUserMode);
                console.log('已保存到localStorage:', localStorage.getItem('currentUserMode'));
                
                console.log('调用updateUserModeDisplay()');
                updateUserModeDisplay();
                
                console.log('调用switchTab(home)');
                switchTab('home');
                
                console.log('调用hideModeSwitch()');
                hideModeSwitch();
                
                console.log('显示成功提示');
                showToast('✅ 已切换到学生模式');
                
                console.log('模式切换完成，当前模式:', currentUserMode);
            }
            
            // 第二重保险：确保弹窗一定关闭
            console.log('=== 第二重保险：再次强制关闭弹窗 ===');
            setTimeout(() => {
                const modal = document.getElementById('modeSwitchModal');
                if (modal && modal.style.display !== 'none') {
                    modal.style.display = 'none';
                    console.log('第二重保险：弹窗已强制关闭');
                } else {
                    console.log('第二重保险：弹窗已经是关闭状态');
                }
            }, 100);
            
            console.log('=== confirmModeSwitch() 函数执行完成 ===');
        }
        
        // 更新用户模式显示
        function updateUserModeDisplay() {
            console.log('updateUserModeDisplay() 被调用，当前模式:', currentUserMode);
            
            const modeText = document.getElementById('currentModeText');
            if (modeText) {
                const newText = currentUserMode === 'student' ? '学生模式' : '家长模式';
                modeText.textContent = newText;
                console.log('已更新模式显示文本为:', newText);
            } else {
                console.log('警告：找不到currentModeText元素');
            }
            
            // 更新个人中心菜单项文本
            const parentModeMenuText = document.getElementById('parentModeMenuText');
            if (parentModeMenuText) {
                const menuText = currentUserMode === 'student' ? '家长模式' : '家长管理中心';
                parentModeMenuText.textContent = menuText;
                console.log('已更新菜单文本为:', menuText);
            }
            
            // 根据模式显示/隐藏相应功能
            console.log('调用updateUIForUserMode()');
            updateUIForUserMode();
        }
        
        // 根据用户模式更新UI
        function updateUIForUserMode() {
            console.log('updateUIForUserMode() 被调用，当前模式:', currentUserMode);
            
            const bottomNav = document.querySelector('.bottom-nav');
            console.log('底部导航元素:', bottomNav ? '找到' : '未找到');
            
            // 确保底部导航始终显示
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                console.log('已显示底部导航');
            } else {
                console.log('警告：找不到底部导航元素');
            }
            
            // 控制家长专用功能按钮的显示
            const parentOnlyActions = document.getElementById('parentOnlyActions');
            if (parentOnlyActions) {
                if (currentUserMode === 'parent') {
                    parentOnlyActions.style.display = 'block';
                    console.log('已显示家长专用功能按钮');
                } else {
                    parentOnlyActions.style.display = 'none';
                    console.log('已隐藏家长专用功能按钮');
                }
            } else {
                console.log('警告：找不到parentOnlyActions元素');
            }
            
            // 确保家长页面被隐藏
            const parentPage = document.getElementById('parentPage');
            if (parentPage) {
                parentPage.style.display = 'none';
                parentPage.classList.remove('active');
                console.log('已隐藏家长页面');
            } else {
                console.log('警告：找不到parentPage元素');
            }
            
            // 确保首页正确显示
            const homePage = document.getElementById('homePage');
            if (homePage) {
                // 先隐藏所有页面
                const allPages = document.querySelectorAll('.page');
                allPages.forEach(page => {
                    page.style.display = 'none';
                    page.classList.remove('active');
                });
                
                // 显示首页
                homePage.style.display = 'block';
                homePage.classList.add('active');
                console.log('已显示首页');
                
                // 加载首页数据
                loadHomePage();
                console.log('已加载首页数据');
            } else {
                console.log('警告：找不到homePage元素');
            }
            
            console.log('updateUIForUserMode() 执行完成');
        }
        
        // 加载家长管理页面
        function loadParentPage() {
            updateParentAnalysis();
            updateTaskPointsSummary();
            updateProductsSummary();
        }
        
        // 更新家长数据分析
        function updateParentAnalysis() {
            // 计算本周完成率
            const weeklyRate = calculateWeeklyCompletionRate();
            document.getElementById('weeklyCompletionRate').textContent = weeklyRate + '%';
            
            // 计算平均每日积分
            const avgPoints = calculateAverageDailyPoints();
            document.getElementById('avgDailyPoints').textContent = avgPoints;
            
            // 更新连续打卡天数
            document.getElementById('streakDaysParent').textContent = userProfile.streakDays;
        }
        
        // 计算本周完成率
        function calculateWeeklyCompletionRate() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            // 计算本周完成的任务数
            const weekCompletedTasks = completedTasks.filter(task => {
                const taskDate = new Date(task.date || task.completedAt || Date.now());
                return taskDate >= weekStart && taskDate <= weekEnd;
            });
            
            // 计算本周应该完成的任务数（基于当前任务列表）
            const dailyTasks = tasks.filter(task => 
                task.type === 'daily' || 
                task.type === 'school' || 
                task.type === 'home'
            ).length;
            
            const weeklyTasks = tasks.filter(task => task.type === 'weekly').length;
            const daysInWeek = Math.min(7, Math.ceil((Date.now() - weekStart.getTime()) / (1000 * 60 * 60 * 24)) + 1);
            
            const totalExpectedTasks = (dailyTasks * daysInWeek) + weeklyTasks;
            
            return totalExpectedTasks > 0 ? Math.round((weekCompletedTasks.length / totalExpectedTasks) * 100) : 0;
        }
        
        // 计算平均每日积分
        function calculateAverageDailyPoints() {
            const days = Math.max(userProfile.streakDays, 1);
            return Math.round(totalPoints / days);
        }
        
        // 加载任务积分列表
        function loadTaskPointsList() {
            const container = document.getElementById('taskPointsList');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">暂无任务</p>';
                return;
            }
            
            container.innerHTML = '';
            tasks.forEach((task, index) => {
                const item = document.createElement('div');
                item.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    border-left: 4px solid ${task.completed ? '#28a745' : '#007bff'};
                `;
                
                const typeIcon = getTaskTypeIcon(task.type);
                const typeName = getTaskTypeName(task.type);
                
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">${typeIcon}</span>
                        <div>
                            <div style="font-weight: 500;">${task.title}</div>
                            <div style="font-size: 12px; color: #666;">${typeName} • 创建者: ${task.createdBy === 'parent' ? '家长' : '学生'}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #007bff; font-weight: bold;">${task.points} 积分</div>
                        <div style="font-size: 12px; color: ${task.completed ? '#28a745' : '#666'};">
                            ${task.completed ? '已完成' : '未完成'}
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // 家长管理功能 - 任务管理
        function showTaskManagementModal() {
            updateTaskManagementSummary();
            loadTaskManagementList();
            document.getElementById('taskManagementModal').style.display = 'flex';
        }
        
        function hideTaskManagementModal() {
            document.getElementById('taskManagementModal').style.display = 'none';
        }
        
        function updateTaskManagementSummary() {
            const totalTasks = tasks.length;
            const activeTasks = tasks.filter(task => !task.completed).length;
            const completedTasks = tasks.filter(task => task.completed).length;
            const totalPoints = tasks.reduce((sum, task) => sum + task.points, 0);
            
            // 更新任务管理板块的统计信息
            const summaryElement = document.querySelector('.task-management-summary .summary-stats');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <div class="summary-item">
                        <div class="summary-number">${totalTasks}</div>
                        <div class="summary-label">总任务</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${activeTasks}</div>
                        <div class="summary-label">进行中</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${completedTasks}</div>
                        <div class="summary-label">已完成</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${totalPoints}</div>
                        <div class="summary-label">总积分</div>
                    </div>
                `;
            }
        }
        
        function loadTaskManagementList() {
            const container = document.getElementById('taskManagementList');
            const filter = document.getElementById('taskManagementFilter').value;
            
            let filteredTasks = tasks;
            if (filter !== 'all') {
                filteredTasks = tasks.filter(task => task.category === filter);
            }
            
            container.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无任务</div>';
                return;
            }
            
            filteredTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-management-item';
                
                const categoryIcons = {
                    'school': '📚',
                    'home': '🏠',
                    'temp': '⚡'
                };
                
                const categoryNames = {
                    'school': '学习任务',
                    'home': '家庭任务',
                    'temp': '临时任务'
                };
                
                const frequencyNames = {
                    'daily': '每日',
                    'weekly': '每周',
                    'weekend': '周末',
                    'current_week': '本周',
                    'temporary': '临时'
                };
                
                const priorityIcons = {
                    'low': '🟢',
                    'medium': '🟡',
                    'high': '🔴'
                };
                
                item.innerHTML = `
                    <div class="task-icon">${categoryIcons[task.category] || '📋'}</div>
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span>${categoryNames[task.category]}</span>
                            <span>${frequencyNames[task.frequency] || task.frequency}</span>
                            <span>${priorityIcons[task.priority] || '🟡'} ${task.priority || 'medium'}</span>
                        </div>
                        <div class="task-bottom-row">
                            <div class="task-creator-info">
                                <span>创建者: ${task.createdBy === 'parent' ? '家长' : '学生'}</span>
                                <span class="task-points">${task.points}分</span>
                                <span class="task-status ${task.completed ? 'inactive' : 'active'}">
                                    ${task.completed ? '已完成' : '进行中'}
                                </span>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-primary" onclick="editTaskFromParent('${task.id}')">✏️ 编辑</button>
                                <button class="btn btn-danger" onclick="showDeleteTaskConfirm('${task.id}')">🗑️ 删除</button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function filterTaskManagement() {
            loadTaskManagementList();
        }
        
        function refreshTaskManagement() {
            updateTaskManagementSummary();
            loadTaskManagementList();
            updateTaskPreview();
            showToast('🔄 任务列表已刷新');
        }
        
        // 更新任务预览
        function updateTaskPreview() {
            const container = document.getElementById('taskPreviewList');
            const filterElement = document.getElementById('taskPreviewFilter');
            
            // 如果预览元素不存在，直接返回
            if (!container || !filterElement) {
                return;
            }
            
            const filter = filterElement.value;
            
            let filteredTasks = tasks;
            if (filter !== 'all') {
                filteredTasks = tasks.filter(task => task.category === filter);
            }
            
            // 只显示前5个任务
            const previewTasks = filteredTasks.slice(0, 5);
            
            container.innerHTML = '';
            
            if (previewTasks.length === 0) {
                container.innerHTML = '<div class="task-preview-item" style="text-align: center; color: #666;">暂无任务</div>';
                return;
            }
            
            previewTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-preview-item';
                
                const categoryIcons = {
                    'school': '📚',
                    'home': '🏠',
                    'temp': '⚡'
                };
                
                const statusClass = task.completed ? 'completed' : 'pending';
                const statusText = task.completed ? '已完成' : '待完成';
                
                item.innerHTML = `
                    <div class="task-preview-icon">${categoryIcons[task.category] || '📋'}</div>
                    <div class="task-preview-content">
                        <div class="task-preview-title">${task.title}</div>
                        <div class="task-preview-meta">
                            <span class="task-preview-points">${task.points}分</span>
                            <span class="task-preview-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            // 如果有更多任务，显示提示
            if (filteredTasks.length > 5) {
                const moreItem = document.createElement('div');
                moreItem.className = 'task-preview-item more-tasks';
                moreItem.innerHTML = `
                    <div class="task-preview-content" style="text-align: center; color: #666;">
                        还有 ${filteredTasks.length - 5} 个任务...
                    </div>
                `;
                container.appendChild(moreItem);
            }
        }
        
        // 家长添加任务功能
        let currentParentPriority = 'medium';
        
        function showAddTaskFromParentModal() {
            // 重置表单
            document.getElementById('parentTaskTitle').value = '';
            document.getElementById('parentTaskCategory').value = 'school';
            document.getElementById('parentTaskFrequency').value = 'daily';
            document.getElementById('parentTaskPoints').value = '5';
            document.getElementById('parentTaskDescription').value = '';
            
            // 重置优先级选择
            document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-priority="medium"]').classList.add('active');
            currentParentPriority = 'medium';
            
            document.getElementById('addTaskFromParentModal').style.display = 'flex';
        }
        
        function hideAddTaskFromParentModal() {
            document.getElementById('addTaskFromParentModal').style.display = 'none';
        }
        
        function selectParentPriority(priority) {
            document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-priority="${priority}"]`).classList.add('active');
            currentParentPriority = priority;
        }
        
        function addTaskFromParent() {
            const title = document.getElementById('parentTaskTitle').value.trim();
            const category = document.getElementById('parentTaskCategory').value;
            const frequency = document.getElementById('parentTaskFrequency').value;
            const points = parseInt(document.getElementById('parentTaskPoints').value);
            const description = document.getElementById('parentTaskDescription').value.trim();
            
            if (!title) {
                showToast('❌ 请输入任务名称');
                return;
            }
            
            if (points < 1 || points > 50) {
                showToast('❌ 积分必须在1-50之间');
                return;
            }
            
            const newTask = {
                id: Date.now().toString(),
                title: title,
                category: category,
                frequency: frequency,
                priority: currentParentPriority,
                points: points,
                description: description,
                completed: false,
                createdBy: 'parent',
                createdAt: new Date().toISOString(),
                completedAt: null
            };
            
            tasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            hideAddTaskFromParentModal();
            loadTaskManagementList();
            updateTaskManagementSummary();
            updateTaskPreview();
            updateStats();
            loadTasks();
            
            showToast(`✅ 任务"${title}"添加成功`);
        }
        
        // 家长编辑任务功能
        let currentEditTaskId = null;
        let currentEditParentPriority = 'medium';
        
        function editTaskFromParent(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showToast('❌ 任务不存在');
                return;
            }
            
            currentEditTaskId = taskId;
            
            // 填充表单
            document.getElementById('editParentTaskTitle').value = task.title;
            document.getElementById('editParentTaskCategory').value = task.category;
            document.getElementById('editParentTaskFrequency').value = task.frequency;
            document.getElementById('editParentTaskPoints').value = task.points;
            document.getElementById('editParentTaskDescription').value = task.description || '';
            
            // 设置优先级
            currentEditParentPriority = task.priority || 'medium';
            document.querySelectorAll('#editTaskFromParentModal .priority-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#editTaskFromParentModal [data-priority="${currentEditParentPriority}"]`).classList.add('active');
            
            document.getElementById('editTaskFromParentModal').style.display = 'flex';
        }
        
        function hideEditTaskFromParentModal() {
            document.getElementById('editTaskFromParentModal').style.display = 'none';
            currentEditTaskId = null;
        }
        
        function selectEditParentPriority(priority) {
            document.querySelectorAll('#editTaskFromParentModal .priority-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#editTaskFromParentModal [data-priority="${priority}"]`).classList.add('active');
            currentEditParentPriority = priority;
        }
        
        function saveEditTaskFromParent() {
            if (!currentEditTaskId) return;
            
            const title = document.getElementById('editParentTaskTitle').value.trim();
            const category = document.getElementById('editParentTaskCategory').value;
            const frequency = document.getElementById('editParentTaskFrequency').value;
            const points = parseInt(document.getElementById('editParentTaskPoints').value);
            const description = document.getElementById('editParentTaskDescription').value.trim();
            
            if (!title) {
                showToast('❌ 请输入任务名称');
                return;
            }
            
            if (points < 1 || points > 50) {
                showToast('❌ 积分必须在1-50之间');
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === currentEditTaskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].title = title;
                tasks[taskIndex].category = category;
                tasks[taskIndex].frequency = frequency;
                tasks[taskIndex].priority = currentEditParentPriority;
                tasks[taskIndex].points = points;
                tasks[taskIndex].description = description;
                
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                hideEditTaskFromParentModal();
                loadTaskManagementList();
                updateTaskManagementSummary();
                updateTaskPreview();
                updateStats();
                loadTasks();
                
                showToast(`✅ 任务"${title}"修改成功`);
            }
        }
        
        // 家长删除任务功能
        let currentDeleteTaskId = null;
        
        function showDeleteTaskConfirm(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showToast('❌ 任务不存在');
                return;
            }
            
            currentDeleteTaskId = taskId;
            
            const categoryNames = {
                'school': '学习任务',
                'home': '家庭任务',
                'temp': '临时任务'
            };
            
            const frequencyNames = {
                'daily': '每日',
                'weekly': '每周',
                'weekend': '周末',
                'current_week': '本周',
                'temporary': '临时'
            };
            
            document.getElementById('deleteTaskName').textContent = task.title;
            document.getElementById('deleteTaskMeta').textContent = 
                `${categoryNames[task.category]} • ${frequencyNames[task.frequency] || task.frequency} • ${task.points}积分`;
            
            document.getElementById('deleteTaskConfirmModal').style.display = 'flex';
        }
        
        function hideDeleteTaskConfirmModal() {
            document.getElementById('deleteTaskConfirmModal').style.display = 'none';
            currentDeleteTaskId = null;
        }
        
        function confirmDeleteTask() {
            if (!currentDeleteTaskId) return;
            
            const taskIndex = tasks.findIndex(t => t.id === currentDeleteTaskId);
            if (taskIndex !== -1) {
                const taskTitle = tasks[taskIndex].title;
                tasks.splice(taskIndex, 1);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                hideDeleteTaskConfirmModal();
                loadTaskManagementList();
                updateTaskManagementSummary();
                updateTaskPreview();
                updateStats();
                loadTasks();
                renderHomeTaskList(); // 更新首页任务列表
                
                showToast(`✅ 任务"${taskTitle}"删除成功`);
            }
        }
        
        function deleteTaskFromParent() {
            if (!currentEditTaskId) return;
            
            hideEditTaskFromParentModal();
            showDeleteTaskConfirm(currentEditTaskId);
        }

        // 家长管理功能 - 任务积分管理
        function showTaskPointsModal() {
            updateTaskPointsSummary();
            loadTaskPointsList();
            document.getElementById('taskPointsModal').style.display = 'flex';
        }
        
        function hideTaskPointsModal() {
            document.getElementById('taskPointsModal').style.display = 'none';
        }
        
        function updateTaskPointsSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            const totalPoints = tasks.reduce((sum, task) => sum + (task.completed ? task.points : 0), 0);
            
            document.getElementById('totalTasksCount').textContent = totalTasks;
            document.getElementById('completedTasksCount').textContent = completedTasks;
            document.getElementById('totalPointsEarned').textContent = totalPoints;
        }
        
        function loadTaskPointsList() {
            const container = document.getElementById('taskPointsEditList');
            const filter = document.getElementById('taskPointsFilter').value;
            
            let filteredTasks = tasks;
            if (filter !== 'all') {
                filteredTasks = tasks.filter(task => task.category === filter);
            }
            
            container.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无任务</div>';
                return;
            }
            
            filteredTasks.forEach(task => {
                const item = document.createElement('div');
                item.className = 'task-points-item';
                
                const categoryNames = {
                    'school': '学习任务',
                    'home': '家庭任务',
                    'temp': '临时任务'
                };
                
                item.innerHTML = `
                    <div class="task-points-info">
                        <div class="task-points-name">${task.title}</div>
                        <div class="task-points-meta">
                            ${categoryNames[task.category]} • ${task.frequency} • 
                            ${task.completed ? '已完成' : '未完成'} • 
                            创建者: ${task.createdBy === 'parent' ? '家长' : '学生'}
                        </div>
                    </div>
                    <div class="task-points-controls">
                        <label style="font-size: 12px; color: #666;">积分:</label>
                        <input type="number" class="points-input" value="${task.points}" 
                               min="1" max="10" data-task-id="${task.id}" 
                               onchange="updateTaskPoints('${task.id}', this.value)">
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function updateTaskPoints(taskId, newPoints) {
            const points = parseInt(newPoints);
            if (points < 1 || points > 10) {
                showToast('❌ 积分必须在1-10之间');
                loadTaskPointsList(); // 重新加载以恢复原值
                return;
            }
            
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].points = points;
                showToast(`✅ 任务"${tasks[taskIndex].title}"积分已更新为${points}分`);
            }
        }
        
        function filterTaskPoints() {
            loadTaskPointsList();
        }
        
        function refreshTaskPoints() {
            updateTaskPointsSummary();
            loadTaskPointsList();
            showToast('🔄 任务列表已刷新');
        }
        
        function saveAllTaskPoints() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            updateTaskPointsSummary();
            updateParentAnalysis();
            showToast('💾 所有任务积分已保存');
        }
        
        function batchEditPoints() {
             const newPoints = prompt('请输入要批量设置的积分值（1-10）：');
             if (newPoints && /^[1-9]$|^10$/.test(newPoints)) {
                 const points = parseInt(newPoints);
                 tasks.forEach(task => {
                     task.points = points;
                 });
                 localStorage.setItem('tasks', JSON.stringify(tasks));
                 loadTaskPointsList();
                 updateTaskPointsSummary();
                 showToast(`✅ 所有任务积分已批量设置为${points}分`);
             } else if (newPoints) {
                 showToast('❌ 请输入1-10之间的数字');
             }
         }
         
         // 积分商品管理功能
         function showProductsModal() {
             updateProductsSummary();
             loadProductsList();
             document.getElementById('productManagementModal').style.display = 'flex';
         }
         
         function hideProductsModal() {
             document.getElementById('productManagementModal').style.display = 'none';
         }
         
         function updateProductsSummary() {
             const totalProducts = products.length;
             const activeProducts = products.filter(product => product.enabled).length;
             const totalExchanges = exchangeHistory.length;
             
             document.getElementById('totalProductsCount').textContent = totalProducts;
             document.getElementById('activeProductsCount').textContent = activeProducts;
             document.getElementById('totalExchangesCount').textContent = totalExchanges;
         }
         
         function loadProductsList() {
             const container = document.getElementById('productsEditList');
             const filter = document.getElementById('productCategoryFilter').value;
             
             let filteredProducts = products;
             if (filter !== 'all') {
                 filteredProducts = products.filter(product => product.category === filter);
             }
             
             container.innerHTML = '';
             
             if (filteredProducts.length === 0) {
                 container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无商品</div>';
                 return;
             }
             
             filteredProducts.forEach(product => {
                 const item = document.createElement('div');
                 item.className = 'product-item';
                 
                 const categoryNames = {
                     'study': '学习用品',
                     'entertainment': '娱乐时间',
                     'special': '特殊奖励'
                 };
                 
                 item.innerHTML = `
                     <div class="product-icon">${product.icon}</div>
                     <div class="product-details">
                         <div class="product-name">${product.name}</div>
                         <div class="product-description">${product.description}</div>
                         <div class="product-meta">
                             ${categoryNames[product.category]} • ${product.points}积分 • 
                             ${product.enabled ? '启用' : '禁用'}
                         </div>
                     </div>
                     <div class="product-status ${product.enabled ? 'enabled' : 'disabled'}">
                         ${product.enabled ? '✅' : '❌'}
                     </div>
                     <div class="product-actions">
                         <button class="btn-small btn-primary" onclick="editProduct('${product.id}')">编辑</button>
                         <button class="btn-small btn-danger" onclick="deleteProduct('${product.id}')">删除</button>
                     </div>
                 `;
                 
                 container.appendChild(item);
             });
         }
         
         function filterProducts() {
             loadProductsList();
         }
         
         function refreshProducts() {
             updateProductsSummary();
             loadProductsList();
             showToast('🔄 商品列表已刷新');
         }
         
         function showAddProductModal() {
             document.getElementById('editProductModal').style.display = 'flex';
             document.getElementById('editProductTitle').textContent = '添加新商品';
             document.getElementById('productForm').reset();
             document.getElementById('productForm').dataset.mode = 'add';
             delete document.getElementById('productForm').dataset.productId;
         }
         
         function editProduct(productId) {
             const product = products.find(p => p.id === productId);
             if (!product) return;
             
             document.getElementById('editProductModal').style.display = 'flex';
             document.getElementById('editProductTitle').textContent = '编辑商品';
             document.getElementById('productName').value = product.name;
             document.getElementById('productDescription').value = product.description;
             document.getElementById('productPoints').value = product.points;
             document.getElementById('productCategory').value = product.category;
             document.getElementById('productIcon').value = product.icon;
             document.getElementById('productEnabled').checked = product.enabled;
             
             document.getElementById('productForm').dataset.mode = 'edit';
             document.getElementById('productForm').dataset.productId = productId;
         }
         
         function hideEditProductModal() {
             document.getElementById('editProductModal').style.display = 'none';
         }
         
         function saveProduct() {
             const form = document.getElementById('productForm');
             const mode = form.dataset.mode;
             const productId = form.dataset.productId;
             
             const name = document.getElementById('productName').value.trim();
             const description = document.getElementById('productDescription').value.trim();
             const points = parseInt(document.getElementById('productPoints').value);
             const category = document.getElementById('productCategory').value;
             const icon = document.getElementById('productIcon').value;
             const enabled = document.getElementById('productEnabled').checked;
             
             if (!name || !description || !points || points < 1) {
                 showToast('❌ 请填写完整的商品信息');
                 return;
             }
             
             const productData = {
                 name,
                 description,
                 points,
                 category,
                 icon,
                 enabled,
                 createdAt: new Date().toISOString()
             };
             
             if (mode === 'add') {
                 productData.id = 'product_' + Date.now();
                 products.push(productData);
                 showToast(`✅ 商品"${name}"已添加`);
             } else if (mode === 'edit') {
                 const index = products.findIndex(p => p.id === productId);
                 if (index !== -1) {
                     products[index] = { ...products[index], ...productData };
                     showToast(`✅ 商品"${name}"已更新`);
                 }
             }
             
             localStorage.setItem('products', JSON.stringify(products));
             hideEditProductModal();
             loadProductsList();
             updateProductsSummary();
         }
         
         function deleteProduct(productId) {
             const product = products.find(p => p.id === productId);
             if (!product) return;
             
             if (confirm(`确定要删除商品"${product.name}"吗？`)) {
                 const index = products.findIndex(p => p.id === productId);
                 if (index !== -1) {
                     products.splice(index, 1);
                     localStorage.setItem('products', JSON.stringify(products));
                     loadProductsList();
                     updateProductsSummary();
                     showToast(`✅ 商品"${product.name}"已删除`);
                 }
             }
         }
         
         function selectIcon(icon) {
             document.getElementById('productIcon').value = icon;
             // 更新图标选择器的视觉反馈
             document.querySelectorAll('.icon-btn').forEach(option => {
                 option.classList.remove('selected');
             });
             event.target.classList.add('selected');
         }
         
         function showExchangeHistoryModal() {
             loadExchangeHistory();
             document.getElementById('exchangeHistoryModal').style.display = 'flex';
         }
         
         function hideExchangeHistoryModal() {
             document.getElementById('exchangeHistoryModal').style.display = 'none';
         }
         
         function loadExchangeHistory() {
             const container = document.getElementById('exchangeHistoryList');
             const dateFilter = document.getElementById('exchangeDateFilter').value;
             const categoryFilter = document.getElementById('exchangeCategoryFilter').value;
             
             let filteredHistory = exchangeHistory;
             
             // 日期过滤
             if (dateFilter) {
                 const filterDate = new Date(dateFilter);
                 filteredHistory = filteredHistory.filter(exchange => {
                     const exchangeDate = new Date(exchange.date);
                     return exchangeDate.toDateString() === filterDate.toDateString();
                 });
             }
             
             // 分类过滤
             if (categoryFilter !== 'all') {
                 filteredHistory = filteredHistory.filter(exchange => {
                     const product = products.find(p => p.id === exchange.productId);
                     return product && product.category === categoryFilter;
                 });
             }
             
             container.innerHTML = '';
             
             if (filteredHistory.length === 0) {
                 container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无兑换记录</div>';
                 return;
             }
             
             filteredHistory.forEach(exchange => {
                 const product = products.find(p => p.id === exchange.productId);
                 if (!product) return;
                 
                 const item = document.createElement('div');
                 item.className = 'exchange-item';
                 
                 const date = new Date(exchange.date).toLocaleDateString('zh-CN');
                 
                 item.innerHTML = `
                     <div class="exchange-icon">${product.icon}</div>
                     <div class="exchange-details">
                         <div class="exchange-product">${product.name}</div>
                         <div class="exchange-meta">${date} • ${exchange.points}积分</div>
                     </div>
                     <div class="exchange-status">已兑换</div>
                 `;
                 
                 container.appendChild(item);
             });
         }
         
         function filterExchangeHistory() {
             loadExchangeHistory();
         }
         
         function exportExchangeHistory() {
             if (exchangeHistory.length === 0) {
                 showToast('❌ 暂无兑换记录可导出');
                 return;
             }
             
             let csvContent = '日期,商品名称,积分,分类\n';
             exchangeHistory.forEach(exchange => {
                 const product = products.find(p => p.id === exchange.productId);
                 if (product) {
                     const date = new Date(exchange.date).toLocaleDateString('zh-CN');
                     const categoryNames = {
                         'study': '学习用品',
                         'entertainment': '娱乐时间',
                         'special': '特殊奖励'
                     };
                     csvContent += `${date},${product.name},${exchange.points},${categoryNames[product.category]}\n`;
                 }
             });
             
             const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.setAttribute('href', url);
             link.setAttribute('download', `兑换记录_${new Date().toLocaleDateString('zh-CN')}.csv`);
             link.style.visibility = 'hidden';
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             
             showToast('✅ 兑换记录已导出');
         }
        
        function changeParentPassword() {
            const newPassword = prompt('请输入新的家长密码（6位数字）：');
            if (newPassword && /^\d{6}$/.test(newPassword)) {
                parentPassword = newPassword;
                localStorage.setItem('parentPassword', parentPassword);
                showToast('✅ 家长密码修改成功');
            } else if (newPassword) {
                showToast('❌ 密码格式错误，请输入6位数字');
            }
        }
        
        function setReminders() {
            showToast('⏰ 提醒设置功能开发中...');
        }
        
        function exportDetailedData() {
            const detailedData = {
                userProfile: userProfile,
                totalPoints: totalPoints,
                completedTasks: completedTasks,
                weeklyCompletionRate: calculateWeeklyCompletionRate(),
                avgDailyPoints: calculateAverageDailyPoints(),
                exchanges: JSON.parse(localStorage.getItem('exchanges') || '[]'),
                exportDate: new Date().toISOString(),
                exportMode: 'parent'
            };
            
            const dataStr = JSON.stringify(detailedData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `parent-report-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('📤 详细数据导出成功！');
        }
        
        // 修改原有的switchTab函数以支持家长页面
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            console.log('switchTab called with:', tabName);
            
            if (tabName === 'parent') {
                // 切换到家长页面
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });
                
                const parentPage = document.getElementById('parentPage');
                if (parentPage) {
                    parentPage.classList.add('active');
                    parentPage.style.display = 'block';
                    loadParentPage();
                }
                return;
            }
            
            // 调用原始的switchTab函数
            if (originalSwitchTab && typeof originalSwitchTab === 'function') {
                originalSwitchTab(tabName);
            } else {
                console.error('originalSwitchTab is not a function:', originalSwitchTab);
                // 如果原始函数不可用，直接执行基本的页面切换逻辑
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                if (typeof event !== 'undefined' && event.target) {
                    event.target.closest('.nav-item').classList.add('active');
                }
                
                document.querySelectorAll('.page').forEach(page => {
                    page.style.display = 'none';
                });
                
                const targetPage = document.getElementById(tabName + 'Page');
                if (targetPage) {
                    targetPage.style.display = 'block';
                    
                    if (tabName === 'stats') {
                        renderStatsPage();
                    } else if (tabName === 'shop') {
                        renderShopPage();
                    } else if (tabName === 'profile') {
                        renderProfilePage();
                    } else if (tabName === 'tasks') {
                        loadTasks();
                        updateTaskDisplay();
                    } else if (tabName === 'home') {
                        loadHomePage();
                    }
                }
            }
        };
        
        // 键盘事件监听
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const modal = document.getElementById('modeSwitchModal');
                if (modal.style.display === 'flex') {
                    confirmModeSwitch();
                }
            }
            if (e.key === 'Escape') {
                hideModeSwitch();
            }
        });
        
        // 编辑任务相关变量
        let editingTaskId = null;
        let selectedEditPriority = 'medium';
        
        // 编辑任务函数
        function editTask(taskId) {
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            if (currentMode !== 'parent') {
                showToast('❌ 只有家长可以编辑任务');
                return;
            }
            
            const task = tasks.find(t => t.id == taskId);
            if (!task) {
                showToast('❌ 任务不存在');
                return;
            }
            
            // 设置编辑任务ID
            editingTaskId = taskId;
            
            // 填充表单数据
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskCategory').value = task.category;
            document.getElementById('editTaskFrequency').value = task.frequency || 'daily';
            document.getElementById('editTaskPoints').value = task.points;
            
            // 设置优先级
            selectedEditPriority = task.priority || 'medium';
            document.querySelectorAll('#editTaskModal .priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const priorityBtn = document.querySelector(`#editTaskModal [data-priority="${selectedEditPriority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active');
            }
            
            // 显示编辑模态框
            document.getElementById('editTaskModal').style.display = 'block';
            document.getElementById('editTaskTitle').focus();
        }
        
        // 隐藏编辑任务模态框
        function hideEditTaskModal() {
            document.getElementById('editTaskModal').style.display = 'none';
            editingTaskId = null;
            selectedEditPriority = 'medium';
            
            // 清空表单
            document.getElementById('editTaskTitle').value = '';
            document.getElementById('editTaskCategory').value = 'school';
            document.getElementById('editTaskFrequency').value = 'daily';
            document.getElementById('editTaskPoints').value = '1';
            
            // 重置优先级按钮
            document.querySelectorAll('#editTaskModal .priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#editTaskModal [data-priority="medium"]').classList.add('active');
        }
        
        // 选择编辑优先级
        function selectEditPriority(priority) {
            selectedEditPriority = priority;
            
            // 更新优先级按钮状态
            document.querySelectorAll('#editTaskModal .priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const priorityBtn = document.querySelector(`#editTaskModal [data-priority="${priority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active');
            }
        }
        
        // 保存编辑的任务
        function saveEditTask() {
            if (!editingTaskId) {
                showToast('❌ 编辑任务ID丢失');
                return;
            }
            
            const title = document.getElementById('editTaskTitle').value.trim();
            const category = document.getElementById('editTaskCategory').value;
            const frequency = document.getElementById('editTaskFrequency').value;
            const points = parseInt(document.getElementById('editTaskPoints').value);
            
            if (!title) {
                showToast('❌ 请输入任务名称');
                return;
            }
            
            if (points < 1 || points > 10) {
                showToast('❌ 积分必须在1-10之间');
                return;
            }
            
            // 找到并更新任务
            const taskIndex = tasks.findIndex(t => t.id == editingTaskId);
            if (taskIndex === -1) {
                showToast('❌ 任务不存在');
                return;
            }
            
            // 更新任务数据
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                title: title,
                category: category,
                frequency: frequency,
                points: points,
                priority: selectedEditPriority,
                updatedAt: new Date().toISOString()
            };
            
            // 保存到本地存储
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // 隐藏模态框
            hideEditTaskModal();
            
            // 跳转到首页
            switchTab('home');
            
            // 重置分类筛选为"全部"并重新渲染任务列表
            filterTasks('all');
            
            showToast('✅ 任务编辑成功');
        }
        
        // 删除任务函数
        function deleteTask(taskId) {
            const currentMode = localStorage.getItem('currentUserMode') || 'student';
            if (currentMode !== 'parent') {
                showToast('❌ 只有家长可以删除任务');
                return;
            }
            
            const task = tasks.find(t => t.id == taskId);
            if (!task) {
                showToast('❌ 任务不存在');
                return;
            }
            
            // 显示确认对话框
            if (confirm(`确定要删除任务"${task.title}"吗？\n\n删除后将无法恢复。`)) {
                // 从任务列表中删除
                const taskIndex = tasks.findIndex(t => t.id == taskId);
                if (taskIndex !== -1) {
                    tasks.splice(taskIndex, 1);
                    
                    // 保存到本地存储
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    
                    // 重新渲染任务列表
                    renderTaskList();
                    renderHomeTaskList(); // 更新首页任务列表
                    
                    showToast('✅ 任务删除成功');
                } else {
                    showToast('❌ 删除失败');
                }
            }
        }
        
        // 初始化权限系统
        function initPermissionSystem() {
            updateUserModeDisplay();
            
            // 更新UI以应用权限控制
            updateUIForUserMode();
        }
        
        // 初始化应用
        init();
        initPermissionSystem();
    </script>
</body>
</html>